# 0811 対人実験 進捗レポート

## 1. 概要

本レポートでは `experiment/` ディレクトリに含まれる Flask アプリケーション（`app.py`）と各 HTML テンプレート（`templates/` 配下）がどのように連携して対人実験を実現しているかを整理する。主な目的は、研究メンバーが処理の全体像を共有し、今後の改良ポイントを特定できるようにすることである。

---

## 2. システム構成

```
experiment/
 ├─ app.py                # Flask アプリ本体
 ├─ requirements.txt      # 依存ライブラリ定義（Flask のみ）
 └─ templates/            # 画面テンプレート
      ├─ simple_ahp.html      # AHP（階層分析）入力 UI
      ├─ p2p_game.html        # P2P 協調ゲーム UI
      ├─ simple_game.html     # 簡易版ゲーム UI（説明用）
      └─ turn_based_game.html # ターン制ゲーム UI（検証用）
```

- **`app.py`** は 50 行程度の小さなルーティング定義のみ。ビジネスロジックはすべてブラウザ側 JavaScript で完結させている。
- **Python 側** で状態を持たないため、サーバ負荷は軽く、デプロイも容易。
- **依存ライブラリ** は `Flask` のみ（`requirements.txt` に記載）。

---

## 3. 処理フロー（ハッピーパス）

```mermaid
flowchart TD
    A[Index (/)] --> B[STEP1: /simple_ahp]
    B -->|localStorage に AHP 結果保存| C[STEP2: /p2p_game]
    C --> D[STEP3: /results]
```

### 3.1 ルーティング一覧

| エンドポイント | テンプレート | 主な役割 |
|-----------------|-------------|----------|
| `/` | ― | `redirect('/simple_ahp')` により AHP 設定へリダイレクト |
| `/simple_ahp` | `simple_ahp.html` |   • 基準(4) と代替案(3)のペア比較を実施<br>  • 進捗バー表示<br>  • 完了後 `localStorage` にデータを書き込み `/p2p_game` へ遷移 |
| `/p2p_game` | `p2p_game.html` |   • 3 AI + 1 人間の P2P 協調ゲーム<br>  • AHP 結果を読み込み初期重み表示<br>  • 12 分タイマー, 重み調整, 大学提案 / チャット / ヒストリ記録 |
| `/turn_game` | `turn_based_game.html` | 同上のターン制 UI （未使用だが動作可能） |
| `/simple_game` | `simple_game.html` | 簡易 UI （デモ・チュートリアル用） |
| `/results` | ― (インライン HTML) | 終了メッセージのみ（将来的に統計表示予定） |

---

## 4. 各テンプレートの詳細

### 4.1 simple_ahp.html
1. **基準比較フェーズ**
   - 4 基準の組合せ \( \binom{4}{2} = 6 \) 行を動的生成。
   - 9 段階の相対尺度をチェックボックスで入力。
   - 6/6 完了で自動的に代替案比較フェーズへ移行（`showAlternativePhase()`）。

2. **代替案比較フェーズ**
   - 基準ごとに 3 大学の組合せ \( \binom{3}{2} = 3 \) 行を動的生成（全 12 行）。
   - 全て入力完了すると「ゲームに進む」ボタンが有効化。

3. **データ保存**
   - `criteriaData` と `alternativeData` を `localStorage` に JSON 文字列として保存。
   - `window.location.href = '/p2p_game'` で遷移。

### 4.2 p2p_game.html
- **画面構成**: ヘッダ（ターン表示）, 観察パネル, 行動入力, 提案表示, チャット, 履歴, 大学ランキング。
- **ゲーム初期化 (`initializeGame()`)**
  1. プレイヤー配列 `['あなた', 'アカデミックAI', 'プラクティカルAI', 'バランスAI']` を用意。
  2. タイマー (15:00) を `setInterval` で更新。
  3. AHP データ (`localStorage`) 取り込み → 重みバー初期値計算 (簡易ランダム)。

- **行動種別**
  - 大学評価変更 `criterionSelect` + `universitySelect` + `actionSelect`
  - 重み調整 `actionSelect` (prefix `weight_`)
  - 提案フロー: `Propose` → 各 AI の `accept / reject` → 履歴テーブル & ランキング更新。

- **終了処理**
  - タイマーゼロ or ユーザが `Quit` → `endGame()` → `/results` へ遷移。

### 4.3 simple_game.html / turn_based_game.html
- **simple_game**: チャット + ランキングのみのライト版。
- **turn_based_game**: `currentPlayerIndex` によりターンを制御する実験用 UI。
- いずれも Flask から直接リンクされており、個別評価や A/B テストに利用可。

---

## 5. フロントエンド ⇔ バックエンドのデータフロー

| 区分 | 保持場所 | 内容 |
|-------|-----------|------|
| AHP 入力 | `localStorage.ahpCriteriaComparisons` | `{ "0,1":9, ... }` 基準ペア → スケール値 |
| AHP 入力 | `localStorage.ahpAlternativeComparisons` | `{ "2-0-1":1/3, ... }` 基準-大学ペア → スケール値 |
| ゲーム状態 | JS 変数 (ブラウザのみ) | `weights`, `rankings`, `history` 等、サーバ送信なし |
| 結果 | 未実装 | `/results` での統計表示は今後実装予定 |

---

## 6. 今後の改善ポイント

1. **サーバ保存**: ログや回答を DB へ保存し、統計解析可能にする。
2. **結果ページ**: `/results` にグラフ可視化を追加。
3. **AI ロジック**: 現状ランダム挙動のため、研究用の強化学習モデルに差し替える。
4. **実験パラメータ**: タイマー長や重み初期値を `/config` API で外部設定可能に。
5. **レスポンシブデザイン**: モバイル向けスタイルを最適化。

---

以上。