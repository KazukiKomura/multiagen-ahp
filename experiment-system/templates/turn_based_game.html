<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大学選択協調ゲーム - ターン制</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #e6ccff;
            padding: 15px;
            border: 2px solid #9966cc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .turn-indicator {
            font-size: 20px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
        }
        .your-turn {
            background-color: #4CAF50;
        }
        .ai-turn {
            background-color: #ff9800;
        }
        .waiting-turn {
            background-color: #757575;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .game-info {
            background-color: #cce6ff;
            border: 2px solid #0066cc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .turn-section {
            background-color: white;
            border: 2px solid #666;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .proposal-section {
            background-color: white;
            border: 2px solid #2196F3;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }
        .waiting-section {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        .action-row {
            display: flex;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
        }
        .action-row label {
            min-width: 120px;
            font-weight: bold;
        }
        select {
            padding: 8px;
            font-size: 14px;
            min-width: 180px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .action-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .action-button:hover {
            background-color: #45a049;
        }
        .action-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .accept-button {
            background-color: #28a745;
        }
        .accept-button:hover {
            background-color: #218838;
        }
        .reject-button {
            background-color: #dc3545;
        }
        .reject-button:hover {
            background-color: #c82333;
        }
        .proposal-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .chat-section {
            background-color: #e8f5e8;
            border: 2px solid #4CAF50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 3px;
        }
        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        .human-message {
            background-color: #e6f3ff;
            text-align: right;
        }
        .ai-message {
            background-color: #f0f0f0;
        }
        .chat-input {
            width: 80%;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .send-button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .history-section {
            background-color: white;
            border: 2px solid #666;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .history-table th,
        .history-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .history-table th {
            background-color: #f0f0f0;
            position: sticky;
            top: 0;
        }
        .human-action {
            background-color: #e6f3ff;
        }
        .ai-action {
            background-color: #fff2e6;
        }
        .proposal {
            background-color: #f0f0ff;
        }
        .accepted {
            background-color: #e8f5e8;
        }
        .rejected {
            background-color: #ffe6e6;
        }
        .current-status {
            margin-top: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 5px;
        }
        .quit-section {
            text-align: center;
            margin-top: 20px;
        }
        .quit-button {
            background-color: #f44336;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <strong>ラウンド:</strong> <span id="currentRound">1</span> / 12
        </div>
        <div class="turn-indicator" id="turnIndicator">
            あなたのターン
        </div>
        <div>
            <strong>残り時間:</strong> <span id="timer">15:00</span>
        </div>
        <div>
            <strong>あなたのスコア:</strong> <span id="userScore">0</span>
        </div>
    </div>

    <div class="container">
        <div class="game-info">
            <p>これは<strong>ターン制</strong>の大学選択協調ゲームです。</p>
            <ul>
                <li>各ターンで1人のプレイヤーが提案を行います</li>
                <li>他のプレイヤーは提案を受け入れるか拒否するかを決めます</li>
                <li>あなたのターンでは提案を作成し、他のターンでは提案に対して判断します</li>
                <li>12ラウンドで最良の大学選択合意を目指します</li>
            </ul>
        </div>

        <!-- Your Turn Section -->
        <div class="turn-section" id="yourTurnSection">
            <h3>🎯 あなたのターン - 提案を作成してください</h3>
            
            <div class="action-row">
                <label>基準:</label>
                <select id="criterionSelect">
                    <option value="">-- 基準を選択 --</option>
                    <option value="0">学術レベル</option>
                    <option value="1">費用</option>
                    <option value="2">立地</option>
                    <option value="3">就職実績</option>
                </select>
            </div>
            
            <div class="action-row">
                <label>大学:</label>
                <select id="universitySelect">
                    <option value="">-- 大学を選択 --</option>
                    <option value="0">A大学</option>
                    <option value="1">B大学</option>
                    <option value="2">C大学</option>
                </select>
            </div>
            
            <div class="action-row">
                <label>提案内容:</label>
                <select id="actionSelect">
                    <option value="">-- 提案内容を選択 --</option>
                    <option value="weight_increase">基準重要度を上げる</option>
                    <option value="weight_decrease">基準重要度を下げる</option>
                    <option value="eval_increase">大学評価を上げる</option>
                    <option value="eval_decrease">大学評価を下げる</option>
                </select>
            </div>
            
            <div class="action-row">
                <button class="action-button" onclick="makeProposal()" id="proposeButton" disabled>
                    提案する
                </button>
            </div>
        </div>

        <!-- AI Turn / Proposal Response Section -->
        <div class="proposal-section" id="proposalSection">
            <h3>💭 提案が届きました</h3>
            <div id="proposalDisplay" class="proposal-display">
                <!-- Proposal details will be inserted here -->
            </div>
            <div class="action-row">
                <button class="action-button accept-button" onclick="respondToProposal(true)">
                    同意する
                </button>
                <button class="action-button reject-button" onclick="respondToProposal(false)">
                    拒否する
                </button>
            </div>
        </div>

        <!-- Waiting Section -->
        <div class="waiting-section" id="waitingSection">
            <h3>⏳ 他のプレイヤーの判断を待っています...</h3>
            <p>現在の提案に対する他のAIエージェントの回答を集計中です。</p>
            <div id="responseStatus">
                <p>回答状況: <span id="responseCount">0</span> / 3</p>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <h3>💬 チャット</h3>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message ai-message">
                    <strong>アカデミックAI:</strong> よろしくお願いします。学術レベルを重視した議論をしていきましょう。
                </div>
            </div>
            <div style="margin-top: 10px;">
                <input type="text" id="chatInput" class="chat-input" placeholder="メッセージを入力..." maxlength="200">
                <button class="send-button" onclick="sendMessage()">送信</button>
            </div>
        </div>

        <!-- Action History -->
        <div class="history-section">
            <h3>📋 アクション履歴</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>ラウンド</th>
                        <th>提案者</th>
                        <th>提案内容</th>
                        <th>結果</th>
                        <th>詳細</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- History entries will be added here -->
                </tbody>
            </table>
        </div>

        <!-- Current Status -->
        <div class="current-status">
            <h4>📊 現在の状況</h4>
            <div id="currentWeights">
                <strong>基準重要度:</strong> 学術レベル(25%) | 費用(25%) | 立地(25%) | 就職実績(25%)
            </div>
            <div id="topUniversity" style="margin-top: 10px;">
                <strong>現在の第1候補:</strong> A大学 (総合スコア: 0.75)
            </div>
        </div>

        <!-- Quit section -->
        <div class="quit-section">
            <button class="quit-button" onclick="quitGame()">
                ゲームを終了する
            </button>
        </div>
    </div>

    <script>
        // Game state
        let currentRound = 1;
        let maxRounds = 12;
        let currentTurn = 'human'; // 'human', 'ai1', 'ai2', 'ai3'
        let remainingTime = 15 * 60; // 15 minutes
        let gameTimer;
        let actionCounter = 1;
        let currentProposal = null;
        let waitingForResponses = false;

        const players = ['あなた', 'アカデミックAI', 'プラクティカルAI', 'バランスAI'];
        const aiAgents = ['アカデミックAI', 'プラクティカルAI', 'バランスAI'];

        // Initialize game
        function initializeGame() {
            startTimer();
            updateTurnDisplay();
            updateGameState();
            
            // Add event listeners
            document.getElementById('criterionSelect').addEventListener('change', validateProposal);
            document.getElementById('universitySelect').addEventListener('change', validateProposal);
            document.getElementById('actionSelect').addEventListener('change', validateProposal);
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        }

        // Timer functions
        function startTimer() {
            gameTimer = setInterval(() => {
                remainingTime--;
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (remainingTime <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // Turn management
        function updateTurnDisplay() {
            const indicator = document.getElementById('turnIndicator');
            const yourTurn = document.getElementById('yourTurnSection');
            const proposal = document.getElementById('proposalSection');
            const waiting = document.getElementById('waitingSection');

            // Hide all sections first
            yourTurn.style.display = 'none';
            proposal.style.display = 'none';
            waiting.style.display = 'none';

            if (waitingForResponses) {
                waiting.style.display = 'block';
                indicator.textContent = '回答待ち';
                indicator.className = 'turn-indicator waiting-turn';
            } else if (currentTurn === 'human') {
                yourTurn.style.display = 'block';
                indicator.textContent = 'あなたのターン';
                indicator.className = 'turn-indicator your-turn';
            } else {
                proposal.style.display = 'block';
                indicator.textContent = `${currentTurn}のターン`;
                indicator.className = 'turn-indicator ai-turn';
            }

            document.getElementById('currentRound').textContent = currentRound;
        }

        // Proposal validation
        function validateProposal() {
            const criterion = document.getElementById('criterionSelect').value;
            const university = document.getElementById('universitySelect').value;
            const action = document.getElementById('actionSelect').value;
            const button = document.getElementById('proposeButton');

            if (action.startsWith('weight_')) {
                button.disabled = !action;
            } else {
                button.disabled = !action || !criterion || !university;
            }
        }

        // Make proposal
        function makeProposal() {
            const criterion = document.getElementById('criterionSelect').value;
            const university = document.getElementById('universitySelect').value;
            const action = document.getElementById('actionSelect').value;

            if (!action) return;

            // Create proposal object
            const proposal = {
                proposer: 'あなた',
                criterion: criterion,
                university: university,
                action: action,
                round: currentRound
            };

            currentProposal = proposal;
            
            // Generate proposal text
            let proposalText = generateProposalText(proposal);
            
            // Add to history
            addToHistory(currentRound, 'あなた', proposalText, '提案中', 'proposal');
            
            // Clear form
            document.getElementById('criterionSelect').value = '';
            document.getElementById('universitySelect').value = '';
            document.getElementById('actionSelect').value = '';
            validateProposal();
            
            // Set waiting state
            waitingForResponses = true;
            updateTurnDisplay();
            
            // Simulate AI responses
            simulateAIResponses(proposal);
        }

        function generateProposalText(proposal) {
            const criteriaNames = ['学術レベル', '費用', '立地', '就職実績'];
            const universityNames = ['A大学', 'B大学', 'C大学'];
            
            let text = '';
            if (proposal.action.startsWith('weight_')) {
                const actionType = proposal.action === 'weight_increase' ? '重要度を上げる' : '重要度を下げる';
                text = `${criteriaNames[proposal.criterion]}の${actionType}`;
            } else {
                const actionType = proposal.action === 'eval_increase' ? '評価を上げる' : '評価を下げる';
                text = `${universityNames[proposal.university]}の${criteriaNames[proposal.criterion]}${actionType}`;
            }
            return text;
        }

        // Simulate AI responses to human proposal
        function simulateAIResponses(proposal) {
            let responseCount = 0;
            const responses = [];
            
            // Update response status
            document.getElementById('responseCount').textContent = responseCount;
            
            aiAgents.forEach((agent, index) => {
                setTimeout(() => {
                    // Random response (could be more sophisticated)
                    const accepted = Math.random() > 0.4; // 60% acceptance rate
                    responses.push({ agent, accepted });
                    responseCount++;
                    
                    document.getElementById('responseCount').textContent = responseCount;
                    
                    if (responseCount === aiAgents.length) {
                        processProposalResults(proposal, responses);
                    }
                }, (index + 1) * 1500); // Staggered responses
            });
        }

        // Process AI proposal and show to human
        function showAIProposal() {
            // Generate random AI proposal
            const proposer = aiAgents[Math.floor(Math.random() * aiAgents.length)];
            const actions = ['weight_increase', 'weight_decrease', 'eval_increase', 'eval_decrease'];
            const action = actions[Math.floor(Math.random() * actions.length)];
            const criterion = Math.floor(Math.random() * 4);
            const university = Math.floor(Math.random() * 3);
            
            const proposal = {
                proposer: proposer,
                criterion: criterion.toString(),
                university: university.toString(),
                action: action,
                round: currentRound
            };
            
            currentProposal = proposal;
            const proposalText = generateProposalText(proposal);
            
            // Display proposal
            document.getElementById('proposalDisplay').innerHTML = `
                <strong>${proposer}からの提案:</strong><br>
                ${proposalText}<br>
                <small>この提案に同意しますか？</small>
            `;
            
            // Add to history
            addToHistory(currentRound, proposer, proposalText, '判断待ち', 'proposal');
        }

        // Respond to proposal
        function respondToProposal(accepted) {
            if (!currentProposal) return;
            
            const result = accepted ? '同意' : '拒否';
            
            // Update history
            updateHistoryResult(currentProposal, result);
            
            // Simulate other AI responses
            const otherResponses = [];
            aiAgents.forEach(agent => {
                if (agent !== currentProposal.proposer) {
                    otherResponses.push({
                        agent: agent,
                        accepted: Math.random() > 0.3 // 70% acceptance from AI
                    });
                }
            });
            
            // Process results
            processProposalResults(currentProposal, [{agent: 'あなた', accepted}, ...otherResponses]);
        }

        // Process proposal results
        function processProposalResults(proposal, responses) {
            const acceptCount = responses.filter(r => r.accepted).length;
            const totalResponses = responses.length;
            
            let resultText;
            let resultClass;
            
            if (acceptCount > totalResponses / 2) {
                resultText = `採用 (${acceptCount}/${totalResponses})`;
                resultClass = 'accepted';
                updateGameState(); // Apply the change
            } else {
                resultText = `却下 (${acceptCount}/${totalResponses})`;
                resultClass = 'rejected';
            }
            
            // Update history
            updateHistoryResult(proposal, resultText, resultClass);
            
            // Add individual responses to chat
            responses.forEach(response => {
                addChatMessage(response.agent, `提案に${response.accepted ? '同意' : '反対'}しました`);
            });
            
            // Next turn
            setTimeout(() => {
                nextTurn();
            }, 2000);
        }

        // Next turn
        function nextTurn() {
            waitingForResponses = false;
            
            if (currentTurn === 'human') {
                currentTurn = 'アカデミックAI';
            } else {
                const currentIndex = aiAgents.indexOf(currentTurn);
                if (currentIndex === aiAgents.length - 1) {
                    // End of round
                    currentRound++;
                    currentTurn = 'human';
                    
                    if (currentRound > maxRounds) {
                        endGame();
                        return;
                    }
                } else {
                    currentTurn = aiAgents[currentIndex + 1];
                }
            }
            
            updateTurnDisplay();
            
            // If AI turn, show their proposal
            if (currentTurn !== 'human') {
                setTimeout(showAIProposal, 1000);
            }
        }

        // Chat functions
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage('あなた', message);
            input.value = '';
            
            // Simulate AI response
            setTimeout(() => {
                const responses = [
                    'なるほど、興味深い視点ですね',
                    'それについてもう少し詳しく教えてください',
                    'データに基づいて考えてみましょう',
                    'バランスの取れた判断が重要ですね',
                    'グループ全体の利益を考慮しましょう'
                ];
                const aiAgent = aiAgents[Math.floor(Math.random() * aiAgents.length)];
                const response = responses[Math.floor(Math.random() * responses.length)];
                addChatMessage(aiAgent, response);
            }, 1000 + Math.random() * 2000);
        }

        function addChatMessage(sender, message) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender === 'あなた' ? 'human-message' : 'ai-message'}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // History functions
        function addToHistory(round, proposer, content, result, className = '') {
            const tableBody = document.getElementById('historyTableBody');
            const row = document.createElement('tr');
            row.className = className;
            row.id = `history-${actionCounter}`;
            row.innerHTML = `
                <td>${round}</td>
                <td>${proposer}</td>
                <td>${content}</td>
                <td id="result-${actionCounter}">${result}</td>
                <td></td>
            `;
            tableBody.appendChild(row);
            actionCounter++;
            
            // Scroll to bottom
            const historySection = document.querySelector('.history-section');
            historySection.scrollTop = historySection.scrollHeight;
        }

        function updateHistoryResult(proposal, result, className = '') {
            const resultCell = document.getElementById(`result-${actionCounter - 1}`);
            const row = document.getElementById(`history-${actionCounter - 1}`);
            
            if (resultCell) {
                resultCell.textContent = result;
            }
            if (row && className) {
                row.classList.add(className);
            }
        }

        // Game state updates
        function updateGameState() {
            // Update scores (simplified)
            const newScore = Math.floor(Math.random() * 50) + 250;
            document.getElementById('userScore').textContent = newScore;
            
            // Update current weights display (simplified)
            const weights = ['25%', '25%', '25%', '25%']; // Could be dynamic
            document.getElementById('currentWeights').innerHTML = 
                `<strong>基準重要度:</strong> 学術レベル(${weights[0]}) | 費用(${weights[1]}) | 立地(${weights[2]}) | 就職実績(${weights[3]})`;
        }

        // Game end
        function endGame() {
            clearInterval(gameTimer);
            alert('ゲーム終了！結果ページに移動します。');
            window.location.href = '/results';
        }

        function quitGame() {
            if (confirm('本当にゲームを終了しますか？')) {
                endGame();
            }
        }

        // Initialize when page loads
        window.onload = function() {
            initializeGame();
            
            // Load AHP data from previous page if available
            const criteriaData = localStorage.getItem('ahpCriteriaComparisons');
            const alternativeData = localStorage.getItem('ahpAlternativeComparisons');
            if (criteriaData && alternativeData) {
                console.log('AHP Criteria:', JSON.parse(criteriaData));
                console.log('AHP Alternatives:', JSON.parse(alternativeData));
            }
        };
    </script>
</body>
</html>