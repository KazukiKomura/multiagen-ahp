<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2På¤§å­¦é¸æŠå”èª¿ã‚²ãƒ¼ãƒ </title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #e6ccff;
            padding: 15px;
            border: 2px solid #9966cc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .turn-indicator {
            font-size: 18px;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 5px;
            color: white;
        }
        .ai-turn { background-color: #ff9800; }
        .human-turn { background-color: #4CAF50; }
        .waiting-turn { background-color: #757575; }
        
        .agent-panel {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 15px;
        }
        .agent-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            min-width: 150px;
            text-align: center;
            background-color: white;
        }
        .agent-card.active {
            border-color: #ff9800;
            background-color: #fff3e0;
        }
        .agent-card.human {
            border-color: #4CAF50;
        }
        .agent-card.human.active {
            background-color: #e8f5e8;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .observation-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .obs-section {
            background-color: white;
            border: 2px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
        }
        .obs-section h4 {
            margin-top: 0;
            color: #1976D2;
        }
        .weight-bars {
            margin: 10px 0;
        }
        .weight-bar {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .weight-label {
            min-width: 80px;
            font-size: 12px;
        }
        .weight-visual {
            flex: 1;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 10px;
        }
        .weight-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
        .weight-value {
            min-width: 50px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .metric-item {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .action-section {
            background-color: white;
            border: 2px solid #666;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .proposal-section {
            background-color: white;
            border: 2px solid #2196F3;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }
        .waiting-section {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .action-row {
            display: flex;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
        }
        .action-row label {
            min-width: 120px;
            font-weight: bold;
        }
        select {
            padding: 8px;
            font-size: 14px;
            min-width: 180px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .action-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .action-button:hover { background-color: #45a049; }
        .action-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .accept-button {
            background-color: #28a745;
        }
        .reject-button {
            background-color: #dc3545;
        }
        
        .university-rankings {
            background-color: white;
            border: 2px solid #9c27b0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .ranking-list {
            list-style: none;
            padding: 0;
        }
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .ranking-item:nth-child(1) { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .ranking-item:nth-child(2) { background-color: #f3e5f5; border-left: 4px solid #9c27b0; }
        .ranking-item:nth-child(3) { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        
        .chat-section {
            background-color: #e8f5e8;
            border: 2px solid #4CAF50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .chat-messages {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 3px;
        }
        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        .human-message {
            background-color: #e6f3ff;
            text-align: right;
        }
        .ai-message {
            background-color: #f0f0f0;
        }
        
        .history-section {
            background-color: white;
            border: 2px solid #666;
            padding: 15px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <div><strong>ãƒ©ã‚¦ãƒ³ãƒ‰:</strong> <span id="currentRound">1</span> / 12</div>
        <div class="turn-indicator" id="turnIndicator">AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1ã®ã‚¿ãƒ¼ãƒ³</div>
        <div><strong>æ®‹ã‚Šæ™‚é–“:</strong> <span id="timer">15:00</span></div>
        <div><strong>ç·å‚åŠ è€…:</strong> 4åï¼ˆã‚ãªãŸ + AIÃ—3ï¼‰</div>
    </div>

    <!-- Agent Status Panel -->
    <div class="agent-panel">
        <div class="agent-card human" id="agent-human">
            <div style="font-weight: bold; color: #4CAF50;">ğŸ‘¤ ã‚ãªãŸ</div>
            <div style="font-size: 12px; margin-top: 5px;">äººé–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
        </div>
        <div class="agent-card active" id="agent-ai1">
            <div style="font-weight: bold; color: #ff9800;">ğŸ¤– AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1</div>
            <div style="font-size: 12px; margin-top: 5px;">ã‚¢ã‚«ãƒ‡ãƒŸãƒƒã‚¯é‡è¦–å‹</div>
        </div>
        <div class="agent-card" id="agent-ai2">
            <div style="font-weight: bold; color: #2196F3;">ğŸ¤– AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ2</div>
            <div style="font-size: 12px; margin-top: 5px;">å®Ÿç”¨é‡è¦–å‹</div>
        </div>
        <div class="agent-card" id="agent-ai3">
            <div style="font-weight: bold; color: #9c27b0;">ğŸ¤– AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ3</div>
            <div style="font-size: 12px; margin-top: 5px;">ãƒãƒ©ãƒ³ã‚¹å‹</div>
        </div>
    </div>

    <div class="container">
        <!-- Main Game Area - Split Layout -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            
            <!-- Left Side: Observation States -->
            <div class="left-panel">
                <!-- Your Current State -->
                <div class="obs-section" style="margin-bottom: 20px;">
                    <h4>ğŸ¯ ã‚ãªãŸã®ç¾åœ¨çŠ¶æ…‹ï¼ˆè¦³æ¸¬å€¤ï¼‰</h4>
                    <div><strong>è‡ªåˆ†ã®åŸºæº–é‡è¦åº¦ (w):</strong></div>
                    <div class="weight-bars">
                        <div class="weight-bar">
                            <div class="weight-label">å­¦è¡“ãƒ¬ãƒ™ãƒ«</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 35%"></div></div>
                            <div class="weight-value">0.35</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">è²»ç”¨</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 25%"></div></div>
                            <div class="weight-value">0.25</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">ç«‹åœ°</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 20%"></div></div>
                            <div class="weight-value">0.20</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">å°±è·å®Ÿç¸¾</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 20%"></div></div>
                            <div class="weight-value">0.20</div>
                        </div>
                    </div>
                    
                    <div class="metric-grid">
                        <div class="metric-item">
                            <strong>é‡ã¿å¤šæ§˜æ€§:</strong><br>
                            H(w) = 0.82
                        </div>
                        <div class="metric-item">
                            <strong>AHPä¸€è²«æ€§:</strong><br>
                            CI = 0.08
                        </div>
                        <div class="metric-item">
                            <strong>å‰å›SI:</strong><br>
                            last_si = 0.45
                        </div>
                        <div class="metric-item">
                            <strong>å‰å›åˆæ„åº¦:</strong><br>
                            last_cons = 0.73
                        </div>
                    </div>
                </div>
                
                <!-- Neighbor Average State -->
                <div class="obs-section" style="margin-bottom: 20px;">
                    <h4>ğŸ‘¥ è¿‘éš£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¹³å‡çŠ¶æ…‹</h4>
                    <div><strong>è¿‘éš£å¹³å‡é‡è¦åº¦ (w_mean):</strong></div>
                    <div class="weight-bars">
                        <div class="weight-bar">
                            <div class="weight-label">å­¦è¡“ãƒ¬ãƒ™ãƒ«</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 30%"></div></div>
                            <div class="weight-value">0.30</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">è²»ç”¨</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 28%"></div></div>
                            <div class="weight-value">0.28</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">ç«‹åœ°</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 22%"></div></div>
                            <div class="weight-value">0.22</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">å°±è·å®Ÿç¸¾</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 20%"></div></div>
                            <div class="weight-value">0.20</div>
                        </div>
                    </div>
                    
                    <div class="metric-grid">
                        <div class="metric-item">
                            <strong>ä¹–é›¢åº¦:</strong><br>
                            |w - w_mean| = 0.12
                        </div>
                        <div class="metric-item">
                            <strong>è¿‘éš£æ¨™æº–åå·®:</strong><br>
                            w_std = 0.08
                        </div>
                        <div class="metric-item">
                            <strong>å±€æ‰€åˆæ„åº¦:</strong><br>
                            consensus = 0.73
                        </div>
                        <div class="metric-item">
                            <strong>æ¥ç¶šæ•°:</strong><br>
                            neighbors = 3
                        </div>
                    </div>
                </div>

                <!-- Current University Rankings -->
                <div class="university-rankings" style="margin-bottom: 20px;">
                    <h4>ğŸ† ç¾åœ¨ã®å¤§å­¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å¹³å‡ï¼‰</h4>
                    <ol class="ranking-list">
                        <li class="ranking-item">
                            <span><strong>1ä½: Aå¤§å­¦</strong> - ç·åˆç ”ç©¶å¤§å­¦</span>
                            <span style="font-weight: bold; color: #ff9800;">ã‚¹ã‚³ã‚¢: 0.78</span>
                        </li>
                        <li class="ranking-item">
                            <span><strong>2ä½: Cå¤§å­¦</strong> - ç«‹åœ°é‡è¦–å¤§å­¦</span>
                            <span style="font-weight: bold; color: #9c27b0;">ã‚¹ã‚³ã‚¢: 0.65</span>
                        </li>
                        <li class="ranking-item">
                            <span><strong>3ä½: Bå¤§å­¦</strong> - è²»ç”¨åŠ¹ç‡å¤§å­¦</span>
                            <span style="font-weight: bold; color: #4caf50;">ã‚¹ã‚³ã‚¢: 0.57</span>
                        </li>
                    </ol>
                </div>
            </div>

            <!-- Right Side: Interactions -->
            <div class="right-panel">
                <!-- Your Turn Section -->
        <div class="action-section" id="yourTurnSection" style="display: none;">
            <h3>ğŸ¯ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ - ææ¡ˆã‚’ä½œæˆã—ã¦ãã ã•ã„</h3>
            
            <div class="action-row">
                <label>åŸºæº–:</label>
                <select id="criterionSelect">
                    <option value="">-- åŸºæº–ã‚’é¸æŠ --</option>
                    <option value="0">å­¦è¡“ãƒ¬ãƒ™ãƒ«</option>
                    <option value="1">è²»ç”¨</option>
                    <option value="2">ç«‹åœ°</option>
                    <option value="3">å°±è·å®Ÿç¸¾</option>
                </select>
            </div>
            
            <div class="action-row">
                <label>å¤§å­¦:</label>
                <select id="universitySelect">
                    <option value="">-- å¤§å­¦ã‚’é¸æŠ --</option>
                    <option value="0">Aå¤§å­¦</option>
                    <option value="1">Bå¤§å­¦</option>
                    <option value="2">Cå¤§å­¦</option>
                </select>
            </div>
            
            <div class="action-row">
                <label>ææ¡ˆå†…å®¹:</label>
                <select id="actionSelect">
                    <option value="">-- ææ¡ˆå†…å®¹ã‚’é¸æŠ --</option>
                    <option value="weight_increase">åŸºæº–é‡è¦åº¦ã‚’ä¸Šã’ã‚‹</option>
                    <option value="weight_decrease">åŸºæº–é‡è¦åº¦ã‚’ä¸‹ã’ã‚‹</option>
                    <option value="eval_increase">å¤§å­¦è©•ä¾¡ã‚’ä¸Šã’ã‚‹</option>
                    <option value="eval_decrease">å¤§å­¦è©•ä¾¡ã‚’ä¸‹ã’ã‚‹</option>
                </select>
            </div>
            
            <div class="action-row">
                <button class="action-button" onclick="makeProposal()" id="proposeButton" disabled>
                    ææ¡ˆã™ã‚‹
                </button>
            </div>
        </div>

        <!-- AI Proposal Response Section -->
        <div class="proposal-section" id="proposalSection">
            <h3>ğŸ’­ ææ¡ˆãŒå±Šãã¾ã—ãŸ</h3>
            <div id="proposalDisplay">
                <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                    <strong>AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1ã‹ã‚‰ã®ææ¡ˆ:</strong><br>
                    ã€Œå­¦è¡“ãƒ¬ãƒ™ãƒ«ã®é‡è¦åº¦ã‚’ä¸Šã’ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¾ã™ã€<br>
                    <small>ã“ã®ææ¡ˆã«åŒæ„ã—ã¾ã™ã‹ï¼Ÿ</small>
                </div>
            </div>
            <div class="action-row">
                <button class="action-button accept-button" onclick="respondToProposal(true)">
                    åŒæ„ã™ã‚‹
                </button>
                <button class="action-button reject-button" onclick="respondToProposal(false)">
                    æ‹’å¦ã™ã‚‹
                </button>
            </div>
        </div>

        <!-- Waiting Section -->
        <div class="waiting-section" id="waitingSection">
            <h3>â³ AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè€ƒæ…®ä¸­...</h3>
            <p>ç¾åœ¨AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1ãŒæ¬¡ã®è¡Œå‹•ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ã€‚</p>
        </div>

                <!-- Chat Section -->
                <div class="chat-section" style="margin-bottom: 20px;">
                    <h3>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h3>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message ai-message">
                            <strong>AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1:</strong> ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚å­¦è¡“çš„ãªè¦–ç‚¹ã‹ã‚‰è­°è«–ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="text" id="chatInput" style="width: 80%; padding: 8px;" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." maxlength="200">
                        <button onclick="sendMessage()" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 3px;">é€ä¿¡</button>
                    </div>
                </div>

                <!-- Action History -->
                <div class="history-section" style="margin-bottom: 20px;">
                    <h3>ğŸ“‹ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #ccc; padding: 8px;">ãƒ©ã‚¦ãƒ³ãƒ‰</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">ææ¡ˆè€…</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">ææ¡ˆå†…å®¹</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">çµæœ</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- History entries will be added here -->
                        </tbody>
                    </table>
                </div>

                <!-- Quit section -->
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="quitGame()" style="background-color: #f44336; color: white; padding: 10px 30px; border: none; border-radius: 5px; font-size: 16px;">
                        ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let currentRound = 1;
        let maxRounds = 12;
        let currentTurnIndex = 0; // 0=AI1, 1=AI2, 2=AI3, 3=Human
        let remainingTime = 15 * 60;
        let gameTimer;
        let actionCounter = 1;
        let currentProposal = null;

        const players = ['AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1', 'AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ2', 'AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ3', 'ã‚ãªãŸ'];
        const agentIds = ['agent-ai1', 'agent-ai2', 'agent-ai3', 'agent-human'];

        // Initialize game - start with AI agent 1
        function initializeGame() {
            startTimer();
            updateTurnDisplay();
            
            // Add initial system message
            addChatMessage('ã‚·ã‚¹ãƒ†ãƒ ', `ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ ${players[currentTurnIndex]}ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚`);
            
            startAITurn();
        }

        function startTimer() {
            gameTimer = setInterval(() => {
                remainingTime--;
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (remainingTime <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function updateTurnDisplay() {
            const indicator = document.getElementById('turnIndicator');
            const yourTurn = document.getElementById('yourTurnSection');
            const proposal = document.getElementById('proposalSection');
            const waiting = document.getElementById('waitingSection');

            // Hide all sections first
            yourTurn.style.display = 'none';
            proposal.style.display = 'none';
            waiting.style.display = 'none';

            // Clear all agent cards
            agentIds.forEach(id => {
                document.getElementById(id).classList.remove('active');
            });

            // Set active agent
            document.getElementById(agentIds[currentTurnIndex]).classList.add('active');

            // Update turn indicator and show appropriate section
            if (currentTurnIndex === 3) { 
                // Human turn
                yourTurn.style.display = 'block';
                indicator.textContent = 'ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³';
                indicator.className = 'turn-indicator human-turn';
                
                // Reset form validation
                validateForm();
                
            } else { 
                // AI turn - show waiting initially
                waiting.style.display = 'block';
                waiting.innerHTML = `
                    <h3>â³ ${players[currentTurnIndex]}ãŒè€ƒæ…®ä¸­...</h3>
                    <p>ç¾åœ¨${players[currentTurnIndex]}ãŒæ¬¡ã®è¡Œå‹•ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ã€‚</p>
                `;
                indicator.textContent = `${players[currentTurnIndex]}ã®ã‚¿ãƒ¼ãƒ³`;
                indicator.className = 'turn-indicator ai-turn';
            }

            document.getElementById('currentRound').textContent = currentRound;
        }

        function startAITurn() {
            if (currentTurnIndex === 3) return; // Human turn
            
            setTimeout(() => {
                // AI makes a proposal
                showAIProposal();
            }, 2000 + Math.random() * 3000);
        }

        function showAIProposal() {
            const proposer = players[currentTurnIndex];
            
            // Generate random AI proposal
            const actions = ['åŸºæº–é‡è¦åº¦ã‚’ä¸Šã’ã‚‹', 'åŸºæº–é‡è¦åº¦ã‚’ä¸‹ã’ã‚‹', 'å¤§å­¦è©•ä¾¡ã‚’ä¸Šã’ã‚‹', 'å¤§å­¦è©•ä¾¡ã‚’ä¸‹ã’ã‚‹'];
            const criteria = ['å­¦è¡“ãƒ¬ãƒ™ãƒ«', 'è²»ç”¨', 'ç«‹åœ°', 'å°±è·å®Ÿç¸¾'];
            const universities = ['Aå¤§å­¦', 'Bå¤§å­¦', 'Cå¤§å­¦'];
            
            const action = actions[Math.floor(Math.random() * actions.length)];
            const criterion = criteria[Math.floor(Math.random() * criteria.length)];
            const university = universities[Math.floor(Math.random() * universities.length)];
            
            let proposalText = '';
            if (action.includes('åŸºæº–')) {
                proposalText = `${criterion}ã®${action}`;
            } else {
                proposalText = `${university}ã®${criterion}ã«ã¤ã„ã¦${action}`;
            }
            
            currentProposal = {
                proposer: proposer,
                action: proposalText,
                round: currentRound
            };
            
            // Show proposal to human for response
            document.getElementById('waitingSection').style.display = 'none';
            document.getElementById('proposalSection').style.display = 'block';
            document.getElementById('proposalDisplay').innerHTML = `
                <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                    <strong>${proposer}ã‹ã‚‰ã®ææ¡ˆ:</strong><br>
                    ã€Œ${proposalText}ã€<br>
                    <small>ã“ã®ææ¡ˆã«åŒæ„ã—ã¾ã™ã‹ï¼Ÿ</small>
                </div>
            `;
            
            addToHistory(currentRound, proposer, proposalText, 'åˆ¤æ–­å¾…ã¡');
            addChatMessage(proposer, `ææ¡ˆ: ${proposalText}`);
        }

        function respondToProposal(accepted) {
            if (!currentProposal) return;
            
            const result = accepted ? 'åŒæ„' : 'æ‹’å¦';
            
            // Add human response to chat
            addChatMessage('ã‚ãªãŸ', `ææ¡ˆã«${result}ã—ã¾ã—ãŸ`);
            
            // Simulate other AI responses (excluding the proposer)
            let acceptCount = accepted ? 1 : 0;
            let responsePromises = [];
            
            // Random responses from other AIs (not the proposer)
            for (let i = 0; i < 3; i++) {
                if (i !== currentTurnIndex) {
                    const aiAccepted = Math.random() > 0.3; // 70% acceptance
                    if (aiAccepted) acceptCount++;
                    
                    responsePromises.push(new Promise(resolve => {
                        setTimeout(() => {
                            addChatMessage(players[i], `ææ¡ˆã«${aiAccepted ? 'åŒæ„' : 'åå¯¾'}ã—ã¾ã—ãŸ`);
                            resolve();
                        }, (i + 1) * 500);
                    }));
                }
            }
            
            // Wait for all AI responses then process results
            Promise.all(responsePromises).then(() => {
                setTimeout(() => {
                    const totalResponders = 3; // Human + 2 other AIs (excluding proposer)
                    let resultText, resultClass;
                    
                    if (acceptCount > totalResponders / 2) {
                        resultText = `æ¡ç”¨ (${acceptCount}/${totalResponders})`;
                        resultClass = 'accepted';
                        updateObservationState();
                    } else {
                        resultText = `å´ä¸‹ (${acceptCount}/${totalResponders})`;
                        resultClass = 'rejected';
                    }
                    
                    updateHistoryResult(currentProposal, resultText, resultClass);
                    addChatMessage('ã‚·ã‚¹ãƒ†ãƒ ', `ææ¡ˆçµæœ: ${resultText}`);
                    
                    // Move to next turn
                    setTimeout(nextTurn, 1500);
                }, 1000);
            });
        }

        function nextTurn() {
            // Hide current sections
            document.getElementById('proposalSection').style.display = 'none';
            document.getElementById('yourTurnSection').style.display = 'none';
            document.getElementById('waitingSection').style.display = 'none';
            
            // Move to next player
            currentTurnIndex = (currentTurnIndex + 1) % 4;
            
            // Check if we completed a full round (back to AI1)
            if (currentTurnIndex === 0) {
                currentRound++;
                addChatMessage('ã‚·ã‚¹ãƒ†ãƒ ', `--- ãƒ©ã‚¦ãƒ³ãƒ‰ ${currentRound} é–‹å§‹ ---`);
                
                if (currentRound > maxRounds) {
                    endGame();
                    return;
                }
            }
            
            // Clear current proposal
            currentProposal = null;
            
            // Add turn transition message
            if (currentTurnIndex !== 0 || currentRound > 1) { // Don't show for very first turn
                addChatMessage('ã‚·ã‚¹ãƒ†ãƒ ', `--- ${players[currentTurnIndex]}ã®ã‚¿ãƒ¼ãƒ³ã§ã™ ---`);
            }
            
            // Update display and start appropriate turn
            updateTurnDisplay();
            
            if (currentTurnIndex === 3) { 
                // Human turn - show action section
                // Already handled by updateTurnDisplay()
            } else { 
                // AI turn - start AI proposal process
                startAITurn();
            }
        }

        function makeProposal() {
            const criterion = document.getElementById('criterionSelect').value;
            const university = document.getElementById('universitySelect').value;
            const action = document.getElementById('actionSelect').value;

            if (!action) return;

            // Generate proposal text
            const criteriaNames = ['å­¦è¡“ãƒ¬ãƒ™ãƒ«', 'è²»ç”¨', 'ç«‹åœ°', 'å°±è·å®Ÿç¸¾'];
            const universityNames = ['Aå¤§å­¦', 'Bå¤§å­¦', 'Cå¤§å­¦'];
            
            let proposalText = '';
            if (action.startsWith('weight_')) {
                const actionType = action === 'weight_increase' ? 'é‡è¦åº¦ã‚’ä¸Šã’ã‚‹' : 'é‡è¦åº¦ã‚’ä¸‹ã’ã‚‹';
                proposalText = `${criteriaNames[criterion]}ã®${actionType}`;
            } else {
                const actionType = action === 'eval_increase' ? 'è©•ä¾¡ã‚’ä¸Šã’ã‚‹' : 'è©•ä¾¡ã‚’ä¸‹ã’ã‚‹';
                proposalText = `${universityNames[university]}ã®${criteriaNames[criterion]}${actionType}`;
            }
            
            currentProposal = {
                proposer: 'ã‚ãªãŸ',
                action: proposalText,
                round: currentRound
            };
            
            addToHistory(currentRound, 'ã‚ãªãŸ', proposalText, 'å›ç­”å¾…ã¡');
            addChatMessage('ã‚ãªãŸ', `ææ¡ˆ: ${proposalText}`);
            
            // Clear form and disable button
            document.getElementById('criterionSelect').value = '';
            document.getElementById('universitySelect').value = '';
            document.getElementById('actionSelect').value = '';
            document.getElementById('proposeButton').disabled = true;
            
            // Hide action section and show waiting
            document.getElementById('yourTurnSection').style.display = 'none';
            document.getElementById('waitingSection').style.display = 'block';
            document.getElementById('waitingSection').innerHTML = `
                <h3>â³ AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆ¤æ–­ä¸­...</h3>
                <p>ã‚ãªãŸã®ææ¡ˆã€Œ${proposalText}ã€ã«å¯¾ã™ã‚‹å„AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆ¤æ–­ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚</p>
            `;
            
            // Simulate AI responses with promises
            let responsePromises = [];
            let acceptCount = 0;
            
            for (let i = 0; i < 3; i++) {
                const accepted = Math.random() > 0.4; // 60% acceptance
                if (accepted) acceptCount++;
                
                responsePromises.push(new Promise(resolve => {
                    setTimeout(() => {
                        addChatMessage(players[i], `ææ¡ˆã«${accepted ? 'åŒæ„' : 'åå¯¾'}ã—ã¾ã—ãŸ`);
                        resolve();
                    }, (i + 1) * 800);
                }));
            }
            
            // Wait for all AI responses then process results
            Promise.all(responsePromises).then(() => {
                setTimeout(() => {
                    let resultText = acceptCount > 1 ? `æ¡ç”¨ (${acceptCount}/3)` : `å´ä¸‹ (${acceptCount}/3)`;
                    let resultClass = acceptCount > 1 ? 'accepted' : 'rejected';
                    
                    updateHistoryResult(currentProposal, resultText, resultClass);
                    addChatMessage('ã‚·ã‚¹ãƒ†ãƒ ', `ææ¡ˆçµæœ: ${resultText}`);
                    
                    if (acceptCount > 1) {
                        updateObservationState();
                    }
                    
                    // Move to next turn
                    setTimeout(nextTurn, 1500);
                }, 1000);
            });
        }

        function updateObservationState() {
            // Simulate state updates (random changes for demo)
            // In real implementation, this would calculate actual AHP values
            
            // Update weights with small random changes
            const weightElements = document.querySelectorAll('.weight-fill');
            const valueElements = document.querySelectorAll('.weight-value');
            
            weightElements.forEach((element, index) => {
                const currentWidth = parseFloat(element.style.width);
                const change = (Math.random() - 0.5) * 10; // Â±5% change
                const newWidth = Math.max(15, Math.min(50, currentWidth + change));
                element.style.width = newWidth + '%';
                valueElements[index].textContent = (newWidth / 100).toFixed(2);
            });
            
            // Update metrics with random values
            const metricValues = {
                entropy: (Math.random() * 0.3 + 0.7).toFixed(2),
                ci: (Math.random() * 0.15).toFixed(2),
                lastSi: (Math.random() * 0.6 + 0.2).toFixed(2),
                lastCons: (Math.random() * 0.4 + 0.6).toFixed(2)
            };
            
            document.querySelector('.metric-item:nth-child(1)').innerHTML = `<strong>é‡ã¿å¤šæ§˜æ€§:</strong><br>H(w) = ${metricValues.entropy}`;
            document.querySelector('.metric-item:nth-child(2)').innerHTML = `<strong>AHPä¸€è²«æ€§:</strong><br>CI = ${metricValues.ci}`;
            document.querySelector('.metric-item:nth-child(3)').innerHTML = `<strong>å‰å›SI:</strong><br>last_si = ${metricValues.lastSi}`;
            document.querySelector('.metric-item:nth-child(4)').innerHTML = `<strong>å‰å›åˆæ„åº¦:</strong><br>last_cons = ${metricValues.lastCons}`;
        }

        function addChatMessage(sender, message) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender === 'ã‚ãªãŸ' ? 'human-message' : 'ai-message'}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage('ã‚ãªãŸ', message);
            input.value = '';
            
            // Random AI response
            setTimeout(() => {
                const responses = [
                    'ãªã‚‹ã»ã©ã€ãã®è¦–ç‚¹ã¯é‡è¦ã§ã™ã­',
                    'ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†',
                    'ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™',
                    'ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã®åˆæ„ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†'
                ];
                const ai = players[Math.floor(Math.random() * 3)];
                const response = responses[Math.floor(Math.random() * responses.length)];
                addChatMessage(ai, response);
            }, 1000 + Math.random() * 2000);
        }

        function addToHistory(round, proposer, content, result) {
            const tableBody = document.getElementById('historyTableBody');
            const row = document.createElement('tr');
            row.id = `history-${actionCounter}`;
            row.innerHTML = `
                <td style="border: 1px solid #ccc; padding: 8px;">${round}</td>
                <td style="border: 1px solid #ccc; padding: 8px;">${proposer}</td>
                <td style="border: 1px solid #ccc; padding: 8px;">${content}</td>
                <td style="border: 1px solid #ccc; padding: 8px;" id="result-${actionCounter}">${result}</td>
            `;
            tableBody.appendChild(row);
            actionCounter++;
        }

        function updateHistoryResult(proposal, result, className = '') {
            const resultCell = document.getElementById(`result-${actionCounter - 1}`);
            const row = document.getElementById(`history-${actionCounter - 1}`);
            
            if (resultCell) {
                resultCell.textContent = result;
                if (className === 'accepted') {
                    resultCell.style.color = '#28a745';
                    resultCell.style.fontWeight = 'bold';
                } else if (className === 'rejected') {
                    resultCell.style.color = '#dc3545';
                    resultCell.style.fontWeight = 'bold';
                }
            }
        }

        // Form validation
        document.getElementById('criterionSelect')?.addEventListener('change', validateForm);
        document.getElementById('universitySelect')?.addEventListener('change', validateForm);
        document.getElementById('actionSelect')?.addEventListener('change', validateForm);

        function validateForm() {
            const criterion = document.getElementById('criterionSelect')?.value;
            const university = document.getElementById('universitySelect')?.value;
            const action = document.getElementById('actionSelect')?.value;
            const button = document.getElementById('proposeButton');
            
            if (!button) return;
            
            if (action?.startsWith('weight_')) {
                button.disabled = !action;
            } else {
                button.disabled = !action || !criterion || !university;
            }
        }

        function endGame() {
            clearInterval(gameTimer);
            alert('ã‚²ãƒ¼ãƒ çµ‚äº†ï¼çµæœãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚');
            window.location.href = '/results';
        }

        function quitGame() {
            if (confirm('æœ¬å½“ã«ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
                endGame();
            }
        }

        // Chat enter key
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Initialize when page loads
        window.onload = function() {
            initializeGame();
            
            // Load AHP data from previous page if available
            const criteriaData = localStorage.getItem('ahpCriteriaComparisons');
            const alternativeData = localStorage.getItem('ahpAlternativeComparisons');
            if (criteriaData && alternativeData) {
                console.log('AHP Criteria:', JSON.parse(criteriaData));
                console.log('AHP Alternatives:', JSON.parse(alternativeData));
                
                // Could use this data to initialize observation states more realistically
            }
        };
    </script>
</body>
</html>