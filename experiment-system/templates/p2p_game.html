<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2PÂ§ßÂ≠¶ÈÅ∏ÊäûÂçîË™ø„Ç≤„Éº„É†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #e6ccff;
            padding: 15px;
            border: 2px solid #9966cc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .turn-indicator {
            font-size: 18px;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 5px;
            color: white;
        }
        .ai-turn { background-color: #ff9800; }
        .human-turn { background-color: #4CAF50; }
        .waiting-turn { background-color: #757575; }
        
        .agent-panel {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 15px;
        }
        .agent-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            min-width: 150px;
            text-align: center;
            background-color: white;
        }
        .agent-card.active {
            border-color: #ff9800;
            background-color: #fff3e0;
        }
        .agent-card.human {
            border-color: #4CAF50;
        }
        .agent-card.human.active {
            background-color: #e8f5e8;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .observation-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .obs-section {
            background-color: white;
            border: 2px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
        }
        .obs-section h4 {
            margin-top: 0;
            color: #1976D2;
        }
        .weight-bars {
            margin: 10px 0;
        }
        .weight-bar {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .weight-label {
            min-width: 80px;
            font-size: 12px;
        }
        .weight-visual {
            flex: 1;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 10px;
        }
        .weight-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
        .weight-value {
            min-width: 50px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .metric-item {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .action-section {
            background-color: white;
            border: 2px solid #666;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .proposal-section {
            background-color: white;
            border: 2px solid #2196F3;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }
        .waiting-section {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .action-row {
            display: flex;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
        }
        .action-row label {
            min-width: 120px;
            font-weight: bold;
        }
        select {
            padding: 8px;
            font-size: 14px;
            min-width: 180px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .action-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .action-button:hover { background-color: #45a049; }
        .action-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .accept-button {
            background-color: #28a745;
        }
        .reject-button {
            background-color: #dc3545;
        }
        
        .university-rankings {
            background-color: white;
            border: 2px solid #9c27b0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .ranking-list {
            list-style: none;
            padding: 0;
        }
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .ranking-item:nth-child(1) { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .ranking-item:nth-child(2) { background-color: #f3e5f5; border-left: 4px solid #9c27b0; }
        .ranking-item:nth-child(3) { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        
        .chat-section {
            background-color: #e8f5e8;
            border: 2px solid #4CAF50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .chat-messages {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 3px;
        }
        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        .human-message {
            background-color: #e6f3ff;
            text-align: right;
        }
        .ai-message {
            background-color: #f0f0f0;
        }
        
        .history-section {
            background-color: white;
            border: 2px solid #666;
            padding: 15px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <div><strong>„É©„Ç¶„É≥„Éâ:</strong> <span id="currentRound">1</span> / 12</div>
        <div class="turn-indicator" id="turnIndicator">AI„Ç®„Éº„Ç∏„Çß„É≥„Éà1„ÅÆ„Çø„Éº„É≥</div>
        <div><strong>ÊÆã„ÇäÊôÇÈñì:</strong> <span id="timer">15:00</span></div>
        <div><strong>Á∑èÂèÇÂä†ËÄÖ:</strong> 4ÂêçÔºà„ÅÇ„Å™„Åü + AI√ó3Ôºâ</div>
    </div>

    <!-- Agent Status Panel -->
    <div class="agent-panel">
        <div class="agent-card human" id="agent-human">
            <div style="font-weight: bold; color: #4CAF50;">üë§ „ÅÇ„Å™„Åü</div>
            <div style="font-size: 12px; margin-top: 5px;">‰∫∫Èñì„Éó„É¨„Ç§„É§„Éº</div>
        </div>
        <div class="agent-card active" id="agent-ai1">
            <div style="font-weight: bold; color: #ff9800;">ü§ñ AI„Ç®„Éº„Ç∏„Çß„É≥„Éà1</div>
            <div style="font-size: 12px; margin-top: 5px;">„Ç¢„Ç´„Éá„Éü„ÉÉ„ÇØÈáçË¶ñÂûã</div>
        </div>
        <div class="agent-card" id="agent-ai2">
            <div style="font-weight: bold; color: #2196F3;">ü§ñ AI„Ç®„Éº„Ç∏„Çß„É≥„Éà2</div>
            <div style="font-size: 12px; margin-top: 5px;">ÂÆüÁî®ÈáçË¶ñÂûã</div>
        </div>
        <div class="agent-card" id="agent-ai3">
            <div style="font-weight: bold; color: #9c27b0;">ü§ñ AI„Ç®„Éº„Ç∏„Çß„É≥„Éà3</div>
            <div style="font-size: 12px; margin-top: 5px;">„Éê„É©„É≥„ÇπÂûã</div>
        </div>
    </div>

    <div class="container">
        <!-- Main Game Area - Split Layout -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            
            <!-- Left Side: Observation States -->
            <div class="left-panel">
                <!-- Your Current State -->
                <div class="obs-section" style="margin-bottom: 20px;">
                    <h4>üéØ „ÅÇ„Å™„Åü„ÅÆÁèæÂú®Áä∂ÊÖãÔºàË¶≥Ê∏¨ÂÄ§Ôºâ</h4>
                    <div><strong>Ëá™ÂàÜ„ÅÆÂü∫Ê∫ñÈáçË¶ÅÂ∫¶ (w):</strong></div>
                    <div class="weight-bars">
                        <div class="weight-bar">
                            <div class="weight-label">Â≠¶Ë°ì„É¨„Éô„É´</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 35%"></div></div>
                            <div class="weight-value">0.35</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">Ë≤ªÁî®</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 25%"></div></div>
                            <div class="weight-value">0.25</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">Á´ãÂú∞</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 20%"></div></div>
                            <div class="weight-value">0.20</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">Â∞±ËÅ∑ÂÆüÁ∏æ</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 20%"></div></div>
                            <div class="weight-value">0.20</div>
                        </div>
                    </div>
                    
                    <div class="metric-grid">
                        <div class="metric-item">
                            <strong>Èáç„ÅøÂ§öÊßòÊÄß:</strong><br>
                            H(w) = 0.82
                        </div>
                        <div class="metric-item">
                            <strong>AHP‰∏ÄË≤´ÊÄß:</strong><br>
                            CI = 0.08
                        </div>
                        <div class="metric-item">
                            <strong>ÂâçÂõûSI:</strong><br>
                            last_si = 0.45
                        </div>
                        <div class="metric-item">
                            <strong>ÂâçÂõûÂêàÊÑèÂ∫¶:</strong><br>
                            last_cons = 0.73
                        </div>
                    </div>
                </div>
                
                <!-- Neighbor Average State -->
                <div class="obs-section" style="margin-bottom: 20px;">
                    <h4>üë• ËøëÈö£„Ç®„Éº„Ç∏„Çß„É≥„ÉàÂπ≥ÂùáÁä∂ÊÖã</h4>
                    <div><strong>ËøëÈö£Âπ≥ÂùáÈáçË¶ÅÂ∫¶ (w_mean):</strong></div>
                    <div class="weight-bars">
                        <div class="weight-bar">
                            <div class="weight-label">Â≠¶Ë°ì„É¨„Éô„É´</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 30%"></div></div>
                            <div class="weight-value">0.30</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">Ë≤ªÁî®</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 28%"></div></div>
                            <div class="weight-value">0.28</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">Á´ãÂú∞</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 22%"></div></div>
                            <div class="weight-value">0.22</div>
                        </div>
                        <div class="weight-bar">
                            <div class="weight-label">Â∞±ËÅ∑ÂÆüÁ∏æ</div>
                            <div class="weight-visual"><div class="weight-fill" style="width: 20%"></div></div>
                            <div class="weight-value">0.20</div>
                        </div>
                    </div>
                    
                    <div class="metric-grid">
                        <div class="metric-item">
                            <strong>‰πñÈõ¢Â∫¶:</strong><br>
                            |w - w_mean| = 0.12
                        </div>
                        <div class="metric-item">
                            <strong>ËøëÈö£Ê®ôÊ∫ñÂÅèÂ∑Æ:</strong><br>
                            w_std = 0.08
                        </div>
                        <div class="metric-item">
                            <strong>Â±ÄÊâÄÂêàÊÑèÂ∫¶:</strong><br>
                            consensus = 0.73
                        </div>
                        <div class="metric-item">
                            <strong>Êé•Á∂öÊï∞:</strong><br>
                            neighbors = 3
                        </div>
                    </div>
                </div>

                <!-- Current University Rankings -->
                <div class="university-rankings" style="margin-bottom: 20px;">
                    <h4>üèÜ ÁèæÂú®„ÅÆÂ§ßÂ≠¶„É©„É≥„Ç≠„É≥„Ç∞Ôºà„Ç∞„É´„Éº„ÉóÂπ≥ÂùáÔºâ</h4>
                    <ol class="ranking-list">
                        <li class="ranking-item">
                            <span><strong>1‰Ωç: AÂ§ßÂ≠¶</strong> - Á∑èÂêàÁ†îÁ©∂Â§ßÂ≠¶</span>
                            <span style="font-weight: bold; color: #ff9800;">„Çπ„Ç≥„Ç¢: 0.78</span>
                        </li>
                        <li class="ranking-item">
                            <span><strong>2‰Ωç: CÂ§ßÂ≠¶</strong> - Á´ãÂú∞ÈáçË¶ñÂ§ßÂ≠¶</span>
                            <span style="font-weight: bold; color: #9c27b0;">„Çπ„Ç≥„Ç¢: 0.65</span>
                        </li>
                        <li class="ranking-item">
                            <span><strong>3‰Ωç: BÂ§ßÂ≠¶</strong> - Ë≤ªÁî®ÂäπÁéáÂ§ßÂ≠¶</span>
                            <span style="font-weight: bold; color: #4caf50;">„Çπ„Ç≥„Ç¢: 0.57</span>
                        </li>
                    </ol>
                </div>
            </div>

            <!-- Right Side: Interactions -->
            <div class="right-panel">
                <!-- Your Turn Section -->
        <div class="action-section" id="yourTurnSection" style="display: none;">
            <h3>üéØ „ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥ - ÊèêÊ°à„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
            
            <div class="action-row">
                <label>Âü∫Ê∫ñ:</label>
                <select id="criterionSelect">
                    <option value="">-- Âü∫Ê∫ñ„ÇíÈÅ∏Êäû --</option>
                    <option value="0">Â≠¶Ë°ì„É¨„Éô„É´</option>
                    <option value="1">Ë≤ªÁî®</option>
                    <option value="2">Á´ãÂú∞</option>
                    <option value="3">Â∞±ËÅ∑ÂÆüÁ∏æ</option>
                </select>
            </div>
            
            <div class="action-row">
                <label>Â§ßÂ≠¶:</label>
                <select id="universitySelect">
                    <option value="">-- Â§ßÂ≠¶„ÇíÈÅ∏Êäû --</option>
                    <option value="0">AÂ§ßÂ≠¶</option>
                    <option value="1">BÂ§ßÂ≠¶</option>
                    <option value="2">CÂ§ßÂ≠¶</option>
                </select>
            </div>
            
            <div class="action-row">
                <label>ÊèêÊ°àÂÜÖÂÆπ:</label>
                <select id="actionSelect">
                    <option value="">-- ÊèêÊ°àÂÜÖÂÆπ„ÇíÈÅ∏Êäû --</option>
                    <option value="weight_increase">Âü∫Ê∫ñÈáçË¶ÅÂ∫¶„Çí‰∏ä„Åí„Çã</option>
                    <option value="weight_decrease">Âü∫Ê∫ñÈáçË¶ÅÂ∫¶„Çí‰∏ã„Åí„Çã</option>
                    <option value="eval_increase">Â§ßÂ≠¶Ë©ï‰æ°„Çí‰∏ä„Åí„Çã</option>
                    <option value="eval_decrease">Â§ßÂ≠¶Ë©ï‰æ°„Çí‰∏ã„Åí„Çã</option>
                </select>
            </div>
            
            <div class="action-row">
                <button class="action-button" onclick="makeProposal()" id="proposeButton" disabled>
                    ÊèêÊ°à„Åô„Çã
                </button>
            </div>
        </div>

        <!-- AI Proposal Response Section -->
        <div class="proposal-section" id="proposalSection">
            <h3>üí≠ ÊèêÊ°à„ÅåÂ±ä„Åç„Åæ„Åó„Åü</h3>
            <div id="proposalDisplay">
                <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                    <strong>AI„Ç®„Éº„Ç∏„Çß„É≥„Éà1„Åã„Çâ„ÅÆÊèêÊ°à:</strong><br>
                    „ÄåÂ≠¶Ë°ì„É¨„Éô„É´„ÅÆÈáçË¶ÅÂ∫¶„Çí‰∏ä„Åí„Çã„Åì„Å®„ÇíÊèêÊ°à„Åó„Åæ„Åô„Äç<br>
                    <small>„Åì„ÅÆÊèêÊ°à„Å´ÂêåÊÑè„Åó„Åæ„Åô„ÅãÔºü</small>
                </div>
            </div>
            <div class="action-row">
                <button class="action-button accept-button" onclick="respondToProposal(true)">
                    ÂêåÊÑè„Åô„Çã
                </button>
                <button class="action-button reject-button" onclick="respondToProposal(false)">
                    ÊãíÂê¶„Åô„Çã
                </button>
            </div>
        </div>

        <!-- Waiting Section -->
        <div class="waiting-section" id="waitingSection">
            <h3>‚è≥ AI„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅåËÄÉÊÖÆ‰∏≠...</h3>
            <p>ÁèæÂú®AI„Ç®„Éº„Ç∏„Çß„É≥„Éà1„ÅåÊ¨°„ÅÆË°åÂãï„ÇíÊ§úË®é„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
        </div>

                <!-- Chat Section -->
                <div class="chat-section" style="margin-bottom: 20px;">
                    <h3>üí¨ „ÉÅ„É£„ÉÉ„Éà</h3>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message ai-message">
                            <strong>AI„Ç®„Éº„Ç∏„Çß„É≥„Éà1:</strong> „Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇÂ≠¶Ë°ìÁöÑ„Å™Ë¶ñÁÇπ„Åã„ÇâË≠∞Ë´ñ„Åó„Å¶„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="text" id="chatInput" style="width: 80%; padding: 8px;" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." maxlength="200">
                        <button onclick="sendMessage()" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 3px;">ÈÄÅ‰ø°</button>
                    </div>
                </div>

                <!-- Action History -->
                <div class="history-section" style="margin-bottom: 20px;">
                    <h3>üìã „Ç¢„ÇØ„Ç∑„Éß„É≥Â±•Ê≠¥</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #ccc; padding: 8px;">„É©„Ç¶„É≥„Éâ</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">ÊèêÊ°àËÄÖ</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">ÊèêÊ°àÂÜÖÂÆπ</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">ÁµêÊûú</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- History entries will be added here -->
                        </tbody>
                    </table>
                </div>

                <!-- Quit section -->
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="quitGame()" style="background-color: #f44336; color: white; padding: 10px 30px; border: none; border-radius: 5px; font-size: 16px;">
                        „Ç≤„Éº„É†„ÇíÁµÇ‰∫Ü„Åô„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let currentRound = 1;
        let maxRounds = 12;
        let currentTurnIndex = 0; // 0=AI1, 1=AI2, 2=AI3, 3=Human
        let remainingTime = 15 * 60;
        let gameTimer;
        let actionCounter = 1;
        let currentProposal = null;

        const players = ['AI„Ç®„Éº„Ç∏„Çß„É≥„Éà1', 'AI„Ç®„Éº„Ç∏„Çß„É≥„Éà2', 'AI„Ç®„Éº„Ç∏„Çß„É≥„Éà3', '„ÅÇ„Å™„Åü'];
        const agentIds = ['agent-ai1', 'agent-ai2', 'agent-ai3', 'agent-human'];

        // Initialize game - start with AI agent 1
        function initializeGame() {
            startTimer();
            updateTurnDisplay();
            
            // Add initial system message
            addChatMessage('„Ç∑„Çπ„ÉÜ„É†', `„Ç≤„Éº„É†ÈñãÂßãÔºÅ ${players[currentTurnIndex]}„Åã„Çâ„Çπ„Çø„Éº„Éà„Åó„Åæ„Åô„ÄÇ`);
            
            startAITurn();
        }

        function startTimer() {
            gameTimer = setInterval(() => {
                remainingTime--;
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (remainingTime <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function updateTurnDisplay() {
            const indicator = document.getElementById('turnIndicator');
            const yourTurn = document.getElementById('yourTurnSection');
            const proposal = document.getElementById('proposalSection');
            const waiting = document.getElementById('waitingSection');

            // Hide all sections first
            yourTurn.style.display = 'none';
            proposal.style.display = 'none';
            waiting.style.display = 'none';

            // Clear all agent cards
            agentIds.forEach(id => {
                document.getElementById(id).classList.remove('active');
            });

            // Set active agent
            document.getElementById(agentIds[currentTurnIndex]).classList.add('active');

            // Update turn indicator and show appropriate section
            if (currentTurnIndex === 3) { 
                // Human turn
                yourTurn.style.display = 'block';
                indicator.textContent = '„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥';
                indicator.className = 'turn-indicator human-turn';
                
                // Reset form validation
                validateForm();
                
            } else { 
                // AI turn - show waiting initially
                waiting.style.display = 'block';
                waiting.innerHTML = `
                    <h3>‚è≥ ${players[currentTurnIndex]}„ÅåËÄÉÊÖÆ‰∏≠...</h3>
                    <p>ÁèæÂú®${players[currentTurnIndex]}„ÅåÊ¨°„ÅÆË°åÂãï„ÇíÊ§úË®é„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
                `;
                indicator.textContent = `${players[currentTurnIndex]}„ÅÆ„Çø„Éº„É≥`;
                indicator.className = 'turn-indicator ai-turn';
            }

            document.getElementById('currentRound').textContent = currentRound;
        }

        function startAITurn() {
            if (currentTurnIndex === 3) return; // Human turn
            
            setTimeout(() => {
                // AI makes a proposal
                showAIProposal();
            }, 2000 + Math.random() * 3000);
        }

        function showAIProposal() {
            const proposer = players[currentTurnIndex];
            
            // Generate random AI proposal
            const actions = ['Âü∫Ê∫ñÈáçË¶ÅÂ∫¶„Çí‰∏ä„Åí„Çã', 'Âü∫Ê∫ñÈáçË¶ÅÂ∫¶„Çí‰∏ã„Åí„Çã', 'Â§ßÂ≠¶Ë©ï‰æ°„Çí‰∏ä„Åí„Çã', 'Â§ßÂ≠¶Ë©ï‰æ°„Çí‰∏ã„Åí„Çã'];
            const criteria = ['Â≠¶Ë°ì„É¨„Éô„É´', 'Ë≤ªÁî®', 'Á´ãÂú∞', 'Â∞±ËÅ∑ÂÆüÁ∏æ'];
            const universities = ['AÂ§ßÂ≠¶', 'BÂ§ßÂ≠¶', 'CÂ§ßÂ≠¶'];
            
            const action = actions[Math.floor(Math.random() * actions.length)];
            const criterion = criteria[Math.floor(Math.random() * criteria.length)];
            const university = universities[Math.floor(Math.random() * universities.length)];
            
            let proposalText = '';
            if (action.includes('Âü∫Ê∫ñ')) {
                proposalText = `${criterion}„ÅÆ${action}`;
            } else {
                proposalText = `${university}„ÅÆ${criterion}„Å´„Å§„ÅÑ„Å¶${action}`;
            }
            
            currentProposal = {
                proposer: proposer,
                action: proposalText,
                round: currentRound
            };
            
            // Show proposal to human for response
            document.getElementById('waitingSection').style.display = 'none';
            document.getElementById('proposalSection').style.display = 'block';
            document.getElementById('proposalDisplay').innerHTML = `
                <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                    <strong>${proposer}„Åã„Çâ„ÅÆÊèêÊ°à:</strong><br>
                    „Äå${proposalText}„Äç<br>
                    <small>„Åì„ÅÆÊèêÊ°à„Å´ÂêåÊÑè„Åó„Åæ„Åô„ÅãÔºü</small>
                </div>
            `;
            
            addToHistory(currentRound, proposer, proposalText, 'Âà§Êñ≠ÂæÖ„Å°');
            addChatMessage(proposer, `ÊèêÊ°à: ${proposalText}`);
        }

        function respondToProposal(accepted) {
            if (!currentProposal) return;
            
            const result = accepted ? 'ÂêåÊÑè' : 'ÊãíÂê¶';
            
            // Add human response to chat
            addChatMessage('„ÅÇ„Å™„Åü', `ÊèêÊ°à„Å´${result}„Åó„Åæ„Åó„Åü`);
            
            // Simulate other AI responses (excluding the proposer)
            let acceptCount = accepted ? 1 : 0;
            let responsePromises = [];
            
            // Random responses from other AIs (not the proposer)
            for (let i = 0; i < 3; i++) {
                if (i !== currentTurnIndex) {
                    const aiAccepted = Math.random() > 0.3; // 70% acceptance
                    if (aiAccepted) acceptCount++;
                    
                    responsePromises.push(new Promise(resolve => {
                        setTimeout(() => {
                            addChatMessage(players[i], `ÊèêÊ°à„Å´${aiAccepted ? 'ÂêåÊÑè' : 'ÂèçÂØæ'}„Åó„Åæ„Åó„Åü`);
                            resolve();
                        }, (i + 1) * 500);
                    }));
                }
            }
            
            // Wait for all AI responses then process results
            Promise.all(responsePromises).then(() => {
                setTimeout(() => {
                    const totalResponders = 3; // Human + 2 other AIs (excluding proposer)
                    let resultText, resultClass;
                    
                    if (acceptCount > totalResponders / 2) {
                        resultText = `Êé°Áî® (${acceptCount}/${totalResponders})`;
                        resultClass = 'accepted';
                        updateObservationState();
                    } else {
                        resultText = `Âç¥‰∏ã (${acceptCount}/${totalResponders})`;
                        resultClass = 'rejected';
                    }
                    
                    updateHistoryResult(currentProposal, resultText, resultClass);
                    addChatMessage('„Ç∑„Çπ„ÉÜ„É†', `ÊèêÊ°àÁµêÊûú: ${resultText}`);
                    
                    // Move to next turn
                    setTimeout(nextTurn, 1500);
                }, 1000);
            });
        }

        function nextTurn() {
            // Hide current sections
            document.getElementById('proposalSection').style.display = 'none';
            document.getElementById('yourTurnSection').style.display = 'none';
            document.getElementById('waitingSection').style.display = 'none';
            
            // Move to next player
            currentTurnIndex = (currentTurnIndex + 1) % 4;
            
            // Check if we completed a full round (back to AI1)
            if (currentTurnIndex === 0) {
                currentRound++;
                addChatMessage('„Ç∑„Çπ„ÉÜ„É†', `--- „É©„Ç¶„É≥„Éâ ${currentRound} ÈñãÂßã ---`);
                
                if (currentRound > maxRounds) {
                    endGame();
                    return;
                }
            }
            
            // Clear current proposal
            currentProposal = null;
            
            // Add turn transition message
            if (currentTurnIndex !== 0 || currentRound > 1) { // Don't show for very first turn
                addChatMessage('„Ç∑„Çπ„ÉÜ„É†', `--- ${players[currentTurnIndex]}„ÅÆ„Çø„Éº„É≥„Åß„Åô ---`);
            }
            
            // Update display and start appropriate turn
            updateTurnDisplay();
            
            if (currentTurnIndex === 3) { 
                // Human turn - show action section
                // Already handled by updateTurnDisplay()
            } else { 
                // AI turn - start AI proposal process
                startAITurn();
            }
        }

        function makeProposal() {
            const criterion = document.getElementById('criterionSelect').value;
            const university = document.getElementById('universitySelect').value;
            const action = document.getElementById('actionSelect').value;

            if (!action) return;

            // Generate proposal text
            const criteriaNames = ['Â≠¶Ë°ì„É¨„Éô„É´', 'Ë≤ªÁî®', 'Á´ãÂú∞', 'Â∞±ËÅ∑ÂÆüÁ∏æ'];
            const universityNames = ['AÂ§ßÂ≠¶', 'BÂ§ßÂ≠¶', 'CÂ§ßÂ≠¶'];
            
            let proposalText = '';
            if (action.startsWith('weight_')) {
                const actionType = action === 'weight_increase' ? 'ÈáçË¶ÅÂ∫¶„Çí‰∏ä„Åí„Çã' : 'ÈáçË¶ÅÂ∫¶„Çí‰∏ã„Åí„Çã';
                proposalText = `${criteriaNames[criterion]}„ÅÆ${actionType}`;
            } else {
                const actionType = action === 'eval_increase' ? 'Ë©ï‰æ°„Çí‰∏ä„Åí„Çã' : 'Ë©ï‰æ°„Çí‰∏ã„Åí„Çã';
                proposalText = `${universityNames[university]}„ÅÆ${criteriaNames[criterion]}${actionType}`;
            }
            
            currentProposal = {
                proposer: '„ÅÇ„Å™„Åü',
                action: proposalText,
                round: currentRound
            };
            
            addToHistory(currentRound, '„ÅÇ„Å™„Åü', proposalText, 'ÂõûÁ≠îÂæÖ„Å°');
            addChatMessage('„ÅÇ„Å™„Åü', `ÊèêÊ°à: ${proposalText}`);
            
            // Clear form and disable button
            document.getElementById('criterionSelect').value = '';
            document.getElementById('universitySelect').value = '';
            document.getElementById('actionSelect').value = '';
            document.getElementById('proposeButton').disabled = true;
            
            // Hide action section and show waiting
            document.getElementById('yourTurnSection').style.display = 'none';
            document.getElementById('waitingSection').style.display = 'block';
            document.getElementById('waitingSection').innerHTML = `
                <h3>‚è≥ AI„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅåÂà§Êñ≠‰∏≠...</h3>
                <p>„ÅÇ„Å™„Åü„ÅÆÊèêÊ°à„Äå${proposalText}„Äç„Å´ÂØæ„Åô„ÇãÂêÑAI„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆÂà§Êñ≠„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
            `;
            
            // Simulate AI responses with promises
            let responsePromises = [];
            let acceptCount = 0;
            
            for (let i = 0; i < 3; i++) {
                const accepted = Math.random() > 0.4; // 60% acceptance
                if (accepted) acceptCount++;
                
                responsePromises.push(new Promise(resolve => {
                    setTimeout(() => {
                        addChatMessage(players[i], `ÊèêÊ°à„Å´${accepted ? 'ÂêåÊÑè' : 'ÂèçÂØæ'}„Åó„Åæ„Åó„Åü`);
                        resolve();
                    }, (i + 1) * 800);
                }));
            }
            
            // Wait for all AI responses then process results
            Promise.all(responsePromises).then(() => {
                setTimeout(() => {
                    let resultText = acceptCount > 1 ? `Êé°Áî® (${acceptCount}/3)` : `Âç¥‰∏ã (${acceptCount}/3)`;
                    let resultClass = acceptCount > 1 ? 'accepted' : 'rejected';
                    
                    updateHistoryResult(currentProposal, resultText, resultClass);
                    addChatMessage('„Ç∑„Çπ„ÉÜ„É†', `ÊèêÊ°àÁµêÊûú: ${resultText}`);
                    
                    if (acceptCount > 1) {
                        updateObservationState();
                    }
                    
                    // Move to next turn
                    setTimeout(nextTurn, 1500);
                }, 1000);
            });
        }

        function updateObservationState() {
            // Simulate state updates (random changes for demo)
            // In real implementation, this would calculate actual AHP values
            
            // Update weights with small random changes
            const weightElements = document.querySelectorAll('.weight-fill');
            const valueElements = document.querySelectorAll('.weight-value');
            
            weightElements.forEach((element, index) => {
                const currentWidth = parseFloat(element.style.width);
                const change = (Math.random() - 0.5) * 10; // ¬±5% change
                const newWidth = Math.max(15, Math.min(50, currentWidth + change));
                element.style.width = newWidth + '%';
                valueElements[index].textContent = (newWidth / 100).toFixed(2);
            });
            
            // Update metrics with random values
            const metricValues = {
                entropy: (Math.random() * 0.3 + 0.7).toFixed(2),
                ci: (Math.random() * 0.15).toFixed(2),
                lastSi: (Math.random() * 0.6 + 0.2).toFixed(2),
                lastCons: (Math.random() * 0.4 + 0.6).toFixed(2)
            };
            
            document.querySelector('.metric-item:nth-child(1)').innerHTML = `<strong>Èáç„ÅøÂ§öÊßòÊÄß:</strong><br>H(w) = ${metricValues.entropy}`;
            document.querySelector('.metric-item:nth-child(2)').innerHTML = `<strong>AHP‰∏ÄË≤´ÊÄß:</strong><br>CI = ${metricValues.ci}`;
            document.querySelector('.metric-item:nth-child(3)').innerHTML = `<strong>ÂâçÂõûSI:</strong><br>last_si = ${metricValues.lastSi}`;
            document.querySelector('.metric-item:nth-child(4)').innerHTML = `<strong>ÂâçÂõûÂêàÊÑèÂ∫¶:</strong><br>last_cons = ${metricValues.lastCons}`;
        }

        function addChatMessage(sender, message) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender === '„ÅÇ„Å™„Åü' ? 'human-message' : 'ai-message'}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage('„ÅÇ„Å™„Åü', message);
            input.value = '';
            
            // Random AI response
            setTimeout(() => {
                const responses = [
                    '„Å™„Çã„Åª„Å©„ÄÅ„Åù„ÅÆË¶ñÁÇπ„ÅØÈáçË¶Å„Åß„Åô„Å≠',
                    '„Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„Å¶ËÄÉ„Åà„Å¶„Åø„Åæ„Åó„Çá„ÅÜ',
                    '„Éê„É©„É≥„Çπ„ÇíËÄÉÊÖÆ„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô',
                    '„Ç∞„É´„Éº„ÉóÂÖ®‰Ωì„ÅÆÂêàÊÑè„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜ'
                ];
                const ai = players[Math.floor(Math.random() * 3)];
                const response = responses[Math.floor(Math.random() * responses.length)];
                addChatMessage(ai, response);
            }, 1000 + Math.random() * 2000);
        }

        function addToHistory(round, proposer, content, result) {
            const tableBody = document.getElementById('historyTableBody');
            const row = document.createElement('tr');
            row.id = `history-${actionCounter}`;
            row.innerHTML = `
                <td style="border: 1px solid #ccc; padding: 8px;">${round}</td>
                <td style="border: 1px solid #ccc; padding: 8px;">${proposer}</td>
                <td style="border: 1px solid #ccc; padding: 8px;">${content}</td>
                <td style="border: 1px solid #ccc; padding: 8px;" id="result-${actionCounter}">${result}</td>
            `;
            tableBody.appendChild(row);
            actionCounter++;
        }

        function updateHistoryResult(proposal, result, className = '') {
            const resultCell = document.getElementById(`result-${actionCounter - 1}`);
            const row = document.getElementById(`history-${actionCounter - 1}`);
            
            if (resultCell) {
                resultCell.textContent = result;
                if (className === 'accepted') {
                    resultCell.style.color = '#28a745';
                    resultCell.style.fontWeight = 'bold';
                } else if (className === 'rejected') {
                    resultCell.style.color = '#dc3545';
                    resultCell.style.fontWeight = 'bold';
                }
            }
        }

        // Form validation
        document.getElementById('criterionSelect')?.addEventListener('change', validateForm);
        document.getElementById('universitySelect')?.addEventListener('change', validateForm);
        document.getElementById('actionSelect')?.addEventListener('change', validateForm);

        function validateForm() {
            const criterion = document.getElementById('criterionSelect')?.value;
            const university = document.getElementById('universitySelect')?.value;
            const action = document.getElementById('actionSelect')?.value;
            const button = document.getElementById('proposeButton');
            
            if (!button) return;
            
            if (action?.startsWith('weight_')) {
                button.disabled = !action;
            } else {
                button.disabled = !action || !criterion || !university;
            }
        }

        function endGame() {
            clearInterval(gameTimer);
            alert('„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅÁµêÊûú„Éö„Éº„Ç∏„Å´ÁßªÂãï„Åó„Åæ„Åô„ÄÇ');
            window.location.href = '/results';
        }

        function quitGame() {
            if (confirm('Êú¨ÂΩì„Å´„Ç≤„Éº„É†„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü')) {
                endGame();
            }
        }

        // Chat enter key
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Initialize when page loads
        window.onload = function() {
            initializeGame();
            
            // Load AHP data from previous page if available
            const criteriaData = localStorage.getItem('ahpCriteriaComparisons');
            const alternativeData = localStorage.getItem('ahpAlternativeComparisons');
            if (criteriaData && alternativeData) {
                console.log('AHP Criteria:', JSON.parse(criteriaData));
                console.log('AHP Alternatives:', JSON.parse(alternativeData));
                
                // Could use this data to initialize observation states more realistically
            }
        };
    </script>
</body>
</html>