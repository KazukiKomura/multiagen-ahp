{% extends "base.html" %} {% block title %}{% if phase == 'pre' %}事前{% else
%}事後{% endif %}質問紙 - 意思決定実験システム{% endblock %} {% block content %}
<div class="questionnaire-section">
    <h2>
        {% if phase == 'pre' %} 事前質問紙 {% else %} {% if trial == 1 %}
        練習セッション完了 - フィードバック {% else %} 事後質問紙 (本番 {{ trial
        - 1 }}/3) {% endif %} {% endif %}
    </h2>

    {% if phase == 'post' and trial == 1 %}
    <div class="trial-complete-message">
        <p>
            <strong>練習セッションが完了しました！</strong><br />
            これから本番セッション1を開始します。練習の経験を活かして判断してください。
        </p>
    </div>
    {% endif %}

    <!-- 共通スタイル（pre/post 両方で使用するエラースタイル） -->
    <style>
        .error {
            border-color: #ef4444 !important;
            background: #fff7f7;
        }
        .error-message {
            color: #b91c1c;
            font-size: 12px;
            margin-top: 6px;
        }
        #formErrors {
            display: none;
            border: 1px solid #fca5a5;
            background: #fff7f7;
            color: #b91c1c;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        #formErrors ul {
            margin: 6px 0 0 16px;
        }
        .slider.unselected {
            opacity: 0.5;
        }
    </style>

    <form id="questionnaireForm" novalidate>
        {% if phase == 'pre' %}
        <style>
            .section-title {
                margin: 18px 0 6px;
                font-weight: 600;
            }
            .subtle {
                color: #6b7280;
                font-size: 12px;
                margin-bottom: 10px;
            }
            .item-block {
                padding: 12px 14px;
                border: 1px solid #e5e7eb;
                border-radius: 10px;
                margin-bottom: 12px;
                background: #fff;
            }
            .item-text {
                margin-bottom: 8px;
                font-weight: 500;
            }
            .range-wrap {
                display: flex;
                gap: 12px;
                align-items: center;
            }
            .slider {
                width: 100%;
                -webkit-appearance: none;
                height: 15px;
                border-radius: 5px;
                background: #d3d3d3;
                outline: none;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            .slider:hover {
                opacity: 1;
            }
            .slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 25px;
                height: 25px;
                border-radius: 50%;
                background: #4caf50;
                cursor: pointer;
            }
            .slider::-moz-range-thumb {
                width: 25px;
                height: 25px;
                border-radius: 50%;
                background: #4caf50;
                cursor: pointer;
            }
            .scale-labels {
                display: flex;
                justify-content: space-between;
                font-size: 12px;
                color: #6b7280;
                margin-top: 4px;
            }
            .scale-endpoints {
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: #4b5563;
                margin-top: 2px;
                font-weight: 500;
            }
            input[type="number"] {
                padding: 8px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                width: 80px;
            }
            .radio-group {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-top: 12px;
            }
            .error {
                border-color: #ef4444 !important;
                background: #fff7f7;
            }
            .error-message {
                color: #b91c1c;
                font-size: 12px;
                margin-top: 6px;
            }
            #formErrors {
                display: none;
                border: 1px solid #fca5a5;
                background: #fff7f7;
                color: #b91c1c;
                padding: 10px;
                border-radius: 8px;
                margin: 10px 0;
            }
            #formErrors ul {
                margin: 6px 0 0 16px;
            }
            .slider.unselected {
                opacity: 0.5;
            }
            .slider.unselected::-webkit-slider-thumb {
                opacity: 0;
            }
            .slider.unselected::-moz-range-thumb {
                opacity: 0;
            }
            .error {
                border-color: #ef4444 !important;
                background: #fff7f7;
            }
            .error-message {
                color: #b91c1c;
                font-size: 12px;
                margin-top: 6px;
            }
            #formErrors {
                display: none;
                border: 1px solid #fca5a5;
                background: #fff7f7;
                color: #b91c1c;
                padding: 10px;
                border-radius: 8px;
                margin: 10px 0;
            }
            #formErrors ul {
                margin: 6px 0 0 16px;
            }
            .slider.unselected {
                opacity: 0.5;
            }
            .slider.unselected::-webkit-slider-thumb {
                opacity: 0;
            }
            .slider.unselected::-moz-range-thumb {
                opacity: 0;
            }
        </style>

        <!-- A) デモグラフィック -->
        <div class="question-group">
            <div class="section-title">A) 基本情報</div>

            <div class="item-block">
                <div class="item-text">A1. 年齢（数値入力）</div>
                <input
                    type="number"
                    id="age"
                    name="age"
                    min="18"
                    max="99"
                    required
                />
            </div>

            <div class="item-block">
                <div class="item-text">A2. 性別（単一選択）</div>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="gender" value="1" required />
                        <span class="radio-custom"></span>
                        1 男性
                    </label>
                    <label>
                        <input type="radio" name="gender" value="2" required />
                        <span class="radio-custom"></span>
                        2 女性
                    </label>
                    <label>
                        <input type="radio" name="gender" value="3" required />
                        <span class="radio-custom"></span>
                        3 その他
                    </label>
                    <label>
                        <input type="radio" name="gender" value="4" required />
                        <span class="radio-custom"></span>
                        4 回答しない
                    </label>
                </div>
            </div>
        </div>

        <!-- B) AI利用経験 -->
        <div class="question-group">
            <div class="section-title">B) AI利用経験</div>

            <div class="item-block">
                <div class="item-text">
                    B1. 過去7日の生成AI（ChatGPT等）利用頻度（単一選択）
                </div>
                <div class="radio-group">
                    <label>
                        <input
                            type="radio"
                            name="llm_use_7d"
                            value="0"
                            required
                        />
                        <span class="radio-custom"></span>
                        0 回
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_use_7d"
                            value="1"
                            required
                        />
                        <span class="radio-custom"></span>
                        1–2 回
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_use_7d"
                            value="2"
                            required
                        />
                        <span class="radio-custom"></span>
                        週 3–4 回
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_use_7d"
                            value="3"
                            required
                        />
                        <span class="radio-custom"></span>
                        ほぼ毎日
                    </label>
                </div>
            </div>

            <div class="item-block">
                <div class="item-text">
                    B2. 過去30日の生成AI（ChatGPT等）利用頻度（単一選択）
                </div>
                <div class="radio-group">
                    <label>
                        <input
                            type="radio"
                            name="llm_use_30d"
                            value="0"
                            required
                        />
                        <span class="radio-custom"></span>
                        0 回
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_use_30d"
                            value="1"
                            required
                        />
                        <span class="radio-custom"></span>
                        1–2 回
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_use_30d"
                            value="2"
                            required
                        />
                        <span class="radio-custom"></span>
                        週 3–4 回 程度
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_use_30d"
                            value="3"
                            required
                        />
                        <span class="radio-custom"></span>
                        ほぼ毎日
                    </label>
                </div>
            </div>

            <div class="item-block">
                <div class="item-text">
                    B3. 生成AI(ChatGPT等)の利用期間（単一選択）
                </div>
                <div class="radio-group">
                    <label>
                        <input
                            type="radio"
                            name="llm_tenure"
                            value="1"
                            required
                        />
                        <span class="radio-custom"></span>
                        未使用
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_tenure"
                            value="2"
                            required
                        />
                        <span class="radio-custom"></span>
                        1か月未満
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_tenure"
                            value="3"
                            required
                        />
                        <span class="radio-custom"></span>
                        1–3か月
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_tenure"
                            value="4"
                            required
                        />
                        <span class="radio-custom"></span>
                        4–6か月
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_tenure"
                            value="5"
                            required
                        />
                        <span class="radio-custom"></span>
                        7–12か月
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_tenure"
                            value="6"
                            required
                        />
                        <span class="radio-custom"></span>
                        1–2年
                    </label>
                    <label>
                        <input
                            type="radio"
                            name="llm_tenure"
                            value="7"
                            required
                        />
                        <span class="radio-custom"></span>
                        2年以上
                    </label>
                </div>
            </div>
        </div>

        <!-- C) AIリテラシ（短尺） -->
        <div class="question-group">
            <div class="section-title">C) AIリテラシ（短尺）</div>
            <div class="subtle">
                1=まったく当てはまらない / 7=非常に当てはまる
            </div>

            <div class="item-block">
                <div class="item-text">
                    C1.
                    私は、生成AI/機械学習の基本的な仕組み（学習データ・モデル・推論・限界）を理解している。
                </div>
                <input
                    type="range"
                    id="ai_literacy_self"
                    name="ai_literacy_self"
                    min="1"
                    max="7"
                    value="4"
                    class="slider"
                    required
                />
                <div class="scale-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                </div>
                <div class="scale-endpoints">
                    <span>全く当てはまらない</span>
                    <span>非常に当てはまる</span>
                </div>
                <div>
                    選択値:
                    <strong
                        ><span id="ai_literacy_self_value">未選択</span></strong
                    >
                </div>
            </div>

            <div class="item-block">
                <div class="item-text">
                    C2. 割合や確率を数字で扱うのが得意だ。
                </div>
                <input
                    type="range"
                    id="sns_q1"
                    name="sns_q1"
                    min="1"
                    max="7"
                    value="4"
                    class="slider"
                    required
                />
                <div class="scale-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                </div>
                <div class="scale-endpoints">
                    <span>全く当てはまらない</span>
                    <span>非常に当てはまる</span>
                </div>
                <div>
                    選択値:
                    <strong><span id="sns_q1_value">未選択</span></strong>
                </div>
            </div>

            <div class="item-block">
                <div class="item-text">
                    C3. 数的な情報を解釈する自信がある。
                </div>
                <input
                    type="range"
                    id="sns_q2"
                    name="sns_q2"
                    min="1"
                    max="7"
                    value="4"
                    class="slider"
                    required
                />
                <div class="scale-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                </div>
                <div class="scale-endpoints">
                    <span>全く当てはまらない</span>
                    <span>非常に当てはまる</span>
                </div>
                <div>
                    選択値:
                    <strong><span id="sns_q2_value">未選択</span></strong>
                </div>
            </div>

            <div class="item-block">
                <div class="item-text">
                    C4.
                    数字による説明より言葉の説明のほうが理解しやすい。（逆転項目）
                </div>
                <input
                    type="range"
                    id="sns_q3"
                    name="sns_q3"
                    min="1"
                    max="7"
                    value="4"
                    class="slider"
                    required
                />
                <div class="scale-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                </div>
                <div class="scale-endpoints">
                    <span>全く当てはまらない</span>
                    <span>非常に当てはまる</span>
                </div>
                <div>
                    選択値:
                    <strong><span id="sns_q3_value">未選択</span></strong>
                </div>
            </div>
        </div>

        {% elif phase == 'post' %}
        <style>
            .section-title {
                margin: 18px 0 6px;
                font-weight: 600;
            }
            .subtle {
                color: #6b7280;
                font-size: 12px;
                margin-bottom: 10px;
            }
            .item-block {
                padding: 12px 14px;
                border: 1px solid #e5e7eb;
                border-radius: 10px;
                margin-bottom: 12px;
                background: #fff;
            }
            .item-text {
                margin-bottom: 8px;
                font-weight: 500;
            }
            .range-wrap {
                display: flex;
                gap: 12px;
                align-items: center;
            }
            .range-wrap input[type="range"] {
                width: 260px;
            }
            .range-help {
                font-size: 12px;
                color: #6b7280;
            }
            .slider {
                width: 100%;
                -webkit-appearance: none;
                height: 15px;
                border-radius: 5px;
                background: #d3d3d3;
                outline: none;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            .slider:hover {
                opacity: 1;
            }
            .slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 25px;
                height: 25px;
                border-radius: 50%;
                background: #4caf50;
                cursor: pointer;
            }
            .slider::-moz-range-thumb {
                width: 25px;
                height: 25px;
                border-radius: 50%;
                background: #4caf50;
                cursor: pointer;
            }
            .scale-labels {
                display: flex;
                justify-content: space-between;
                font-size: 12px;
                color: #6b7280;
                margin-top: 4px;
            }
            .scale-endpoints {
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: #4b5563;
                margin-top: 2px;
                font-weight: 500;
            }
        </style>

        <!-- A) SMOJ（Colquitt系短縮・8項目） 7件法 / スライダー形式 -->
        <div class="question-group">
            <div class="section-title">A) 手続と説明・対人配慮</div>
            <div class="subtle">
                1=まったく当てはまらない / 7=非常に当てはまる
            </div>
            {% set smoj_items = [
            'このセッションの意思決定手続きは一貫して適用された',
            '意思決定手続きは偏りなく中立的だった',
            '自分の意見を述べる十分な機会があった',
            '自分の意見が考慮されたと感じる',
            '他の参加者から敬意ある扱いを受けた', 'やり取りは礼儀正しかった',
            '提供された説明は十分だった', '説明は正直で誠実だった' ] %} {% for i
            in range(1, 9) %}
            <div class="item-block">
                <div class="item-text">A{{ i }}. {{ smoj_items[i-1] }}</div>
                <input
                    type="range"
                    id="smoj_{{ i }}"
                    name="smoj_{{ i }}"
                    min="1"
                    max="7"
                    value="4"
                    class="slider"
                    required
                />
                <div class="scale-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                </div>
                <div class="scale-endpoints">
                    <span>全く当てはまらない</span>
                    <span>非常に当てはまる</span>
                </div>
                <div>
                    選択値:
                    <strong><span id="smoj_{{ i }}_value">未選択</span></strong>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- B) XSS（3項） 7件法 / スライダー形式 -->
        <div class="question-group">
            <div class="section-title">B) 説明への満足</div>
            <div class="subtle">
                1=まったく当てはまらない / 7=非常に当てはまる
            </div>
            {% set xss_items = [ '説明は理解しやすかった',
            '説明は自分の疑問に十分に答えていた', '説明は意思決定に役立った' ]
            %} {% for i in range(1, 4) %}
            <div class="item-block">
                <div class="item-text">B{{ i }}. {{ xss_items[i-1] }}</div>
                <input
                    type="range"
                    id="xss_{{ i }}"
                    name="xss_{{ i }}"
                    min="1"
                    max="7"
                    value="4"
                    class="slider"
                    required
                />
                <div class="scale-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                </div>
                <div class="scale-endpoints">
                    <span>全く当てはまらない</span>
                    <span>非常に当てはまる</span>
                </div>
                <div>
                    選択値:
                    <strong><span id="xss_{{ i }}_value">未選択</span></strong>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- C) Outcome Favorability（2項） 7件法 / スライダー形式 -->
        <div class="question-group">
            <div class="section-title">C) 最終結果の好ましさ</div>
            <div class="subtle">
                1=まったく当てはまらない / 7=非常に当てはまる
            </div>
            {% set of_items = [ '最終結果は自分の希望に近い',
            '最終結果は自分にとって有利だった' ] %} {% for i in range(1, 3) %}
            <div class="item-block">
                <div class="item-text">C{{ i }}. {{ of_items[i-1] }}</div>
                <input
                    type="range"
                    id="outcome_fav_{{ i }}"
                    name="outcome_fav_{{ i }}"
                    min="1"
                    max="7"
                    value="4"
                    class="slider"
                    required
                />
                <div class="scale-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                </div>
                <div class="scale-endpoints">
                    <span>全く当てはまらない</span>
                    <span>非常に当てはまる</span>
                </div>
                <div>
                    選択値:
                    <strong
                        ><span id="outcome_fav_{{ i }}_value"
                            >未選択</span
                        ></strong
                    >
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- D) Gas Tank（0–100） クリック式ガスタンク -->
        <div class="question-group">
            <div class="section-title">D) 現在の活力度（0–100）</div>
            <div style="max-width: 400px; margin: 0 auto; padding: 20px 0">
                <div
                    id="gas_tank_container"
                    style="
                        position: relative;
                        height: 80px;
                        border: 2px solid #9ca3af;
                        border-radius: 8px;
                        background: #f3f4f6;
                        cursor: pointer;
                        overflow: hidden;
                    "
                >
                    <!-- 目盛り (5等分) -->
                    <div
                        style="
                            position: absolute;
                            inset: 0;
                            display: flex;
                            justify-content: space-between;
                            padding: 0;
                            pointer-events: none;
                        "
                    >
                        <div
                            style="
                                width: 1px;
                                height: 100%;
                                background: #9ca3af;
                            "
                        ></div>
                        <div
                            style="
                                width: 1px;
                                height: 100%;
                                background: #9ca3af;
                            "
                        ></div>
                        <div
                            style="
                                width: 1px;
                                height: 100%;
                                background: #9ca3af;
                            "
                        ></div>
                        <div
                            style="
                                width: 1px;
                                height: 100%;
                                background: #9ca3af;
                            "
                        ></div>
                        <div
                            style="
                                width: 1px;
                                height: 100%;
                                background: #9ca3af;
                            "
                        ></div>
                    </div>

                    <!-- 燃料レベル -->
                    <div
                        id="gas_tank_fuel"
                        style="
                            position: absolute;
                            bottom: 0;
                            left: 0;
                            background: #fbbf24;
                            height: 100%;
                            width: 0%;
                            transition: all 0.2s;
                        "
                    ></div>

                    <!-- マーカー -->
                    <div
                        id="gas_tank_marker"
                        style="
                            position: absolute;
                            top: 0;
                            bottom: 0;
                            width: 2px;
                            background: #dc2626;
                            left: 0%;
                            opacity: 0;
                        "
                    ></div>

                    <!-- ラベル -->
                    <div
                        style="
                            position: absolute;
                            inset: 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 0 8px;
                            pointer-events: none;
                        "
                    >
                        <span style="font-size: 12px; font-weight: bold"
                            >EMPTY</span
                        >
                        <span style="font-size: 12px; font-weight: bold"
                            >FULL</span
                        >
                    </div>

                    <!-- 選択した値 -->
                    <div
                        style="
                            position: absolute;
                            inset: 0;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            pointer-events: none;
                        "
                    >
                        <span
                            id="gas_tank_percentage"
                            style="
                                background: rgba(255, 255, 255, 0.8);
                                padding: 4px 8px;
                                border-radius: 12px;
                                font-size: 14px;
                                font-weight: bold;
                            "
                            >未選択</span
                        >
                    </div>
                </div>
                <input
                    type="hidden"
                    id="gas_tank"
                    name="gas_tank"
                    value="4"
                    required
                />
            </div>
            <div class="range-help">
                タンクをクリックして選択（0=枯渇、100=満タン）
            </div>
        </div>

        <!-- E) 自分の意思決定への納得感（単一項目） 7件法 -->
        <div class="question-group">
            <div class="section-title">E) 自分の意思決定への納得</div>
            <div class="subtle">
                1=まったく当てはまらない / 7=非常に当てはまる
            </div>
            <div class="item-block">
                <div class="item-text">自分の最終判断に満足している</div>
                <input
                    type="range"
                    id="sat_self"
                    name="sat_self"
                    min="1"
                    max="7"
                    value="4"
                    class="slider"
                    required
                />
                <div class="scale-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                </div>
                <div class="scale-endpoints">
                    <span>全く当てはまらない</span>
                    <span>非常に当てはまる</span>
                </div>
                <div>
                    選択値:
                    <strong><span id="sat_self_value">未選択</span></strong>
                </div>
            </div>
        </div>

        <!-- F) チームの意思決定への納得感（単一項目） 7件法 -->
        <div class="question-group">
            <div class="section-title">F) チーム意思決定への納得</div>
            <div class="subtle">
                1=まったく当てはまらない / 7=非常に当てはまる
            </div>
            <div class="item-block">
                <div class="item-text">チームの最終決定に満足している</div>
                <input
                    type="range"
                    id="sat_team"
                    name="sat_team"
                    min="1"
                    max="7"
                    value="4"
                    class="slider"
                    required
                />
                <div class="scale-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                </div>
                <div class="scale-endpoints">
                    <span>全く当てはまらない</span>
                    <span>非常に当てはまる</span>
                </div>
                <div>
                    選択値:
                    <strong><span id="sat_team_value">未選択</span></strong>
                </div>
            </div>
        </div>
        {% endif %}

        <div id="formErrors"></div>

        <button type="submit" class="btn btn-primary">次へ進む</button>
    </form>
</div>
{% endblock %} {% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // スライダー初期化（未選択状態）と値表示
        const sliders = document.querySelectorAll('.slider');
        sliders.forEach(slider => {
            slider.classList.add('unselected');
            slider.dataset.touched = 'false';
            // 初期値は4に設定されているが、視覚的には未選択として表示
            const valueDisplay = document.getElementById(slider.id + '_value');
            if (valueDisplay) valueDisplay.textContent = '未選択';
            const onInteract = () => {
                slider.dataset.touched = 'true';
                slider.classList.remove('unselected');
                if (valueDisplay) valueDisplay.textContent = slider.value;
                clearError(slider);
            };
            slider.addEventListener('input', onInteract);
            slider.addEventListener('change', onInteract);
            slider.addEventListener('click', onInteract);
        });

        // Gas Tank クリック機能
        const gasTankContainer = document.getElementById('gas_tank_container');
        const gasTankInput = document.getElementById('gas_tank');
        const gasTankFuel = document.getElementById('gas_tank_fuel');
        const gasTankMarker = document.getElementById('gas_tank_marker');
        const gasTankPercentage = document.getElementById('gas_tank_percentage');

        if (gasTankContainer && gasTankInput) {
            gasTankContainer.addEventListener('click', function(e) {
                const rect = this.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = Math.min(Math.max(Math.round((clickX / rect.width) * 100), 0), 100);

                // 値を更新
                gasTankInput.value = percentage;
                if (gasTankFuel) gasTankFuel.style.width = percentage + '%';
                if (gasTankMarker) { gasTankMarker.style.left = percentage + '%'; gasTankMarker.style.opacity = 1; }
                if (gasTankPercentage) gasTankPercentage.textContent = percentage + '%';
                clearError(gasTankContainer);
            });
        }

        const form = document.getElementById('questionnaireForm');

        function addError(element, message) {
            const block = element.closest ? (element.closest('.item-block') || element.closest('.question-group')) : null;
            const target = block || element;
            if (target && target.classList) {
                target.classList.add('error');
                if (!target.querySelector('.error-message')) {
                    const msg = document.createElement('div');
                    msg.className = 'error-message';
                    msg.textContent = message || '未選択です';
                    target.appendChild(msg);
                }
            }
        }

        function clearError(element) {
            const block = element.closest ? (element.closest('.item-block') || element.closest('.question-group')) : null;
            const target = block || element;
            if (target && target.classList) {
                target.classList.remove('error');
                const msg = target.querySelector ? target.querySelector('.error-message') : null;
                if (msg) msg.remove();
            }
        }

        function itemLabelForInput(input) {
            const block = input.closest ? input.closest('.item-block') : null;
            if (!block) return input.name || input.id || '未特定の項目';
            const txt = block.querySelector('.item-text');
            return txt ? txt.textContent.trim() : (input.name || input.id || '未特定の項目');
        }

        // フォーム送信
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // 既存エラーのクリア
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            const errorBox = document.getElementById('formErrors');
            errorBox.style.display = 'none';
            errorBox.innerHTML = '';

            let errors = [];

            // 数値入力（年齢）
            const age = document.getElementById('age');
            if (age) {
                const val = age.value.trim();
                if (!val) {
                    addError(age, '年齢が未入力です');
                    errors.push('A1. 年齢');
                } else {
                    const n = Number(val);
                    const min = age.min ? Number(age.min) : -Infinity;
                    const max = age.max ? Number(age.max) : Infinity;
                    if (Number.isNaN(n) || n < min || n > max) {
                        addError(age, `年齢は${min}〜${max}の数値で入力してください`);
                        errors.push('A1. 年齢（範囲外）');
                    }
                }
                age.addEventListener('input', () => clearError(age));
            }

            // ラジオグループの検証
            document.querySelectorAll('.radio-group').forEach(group => {
                const radios = group.querySelectorAll('input[type="radio"][name]');
                if (!radios.length) return;
                const anyChecked = Array.from(radios).some(r => r.checked);
                if (!anyChecked) {
                    addError(group, '選択されていません');
                    errors.push(itemLabelForInput(radios[0]));
                }
                radios.forEach(r => r.addEventListener('change', () => clearError(group)));
            });

            // スライダーの検証（操作されるまで未選択扱い）
            document.querySelectorAll('.slider').forEach(slider => {
                if (slider.dataset.touched !== 'true') {
                    addError(slider, 'スライダーが未選択です');
                    errors.push(itemLabelForInput(slider));
                }
            });

            // Gas Tank の検証
            if (gasTankInput) {
                if (!gasTankInput.value) {
                    addError(gasTankContainer, 'タンクが未選択です');
                    errors.push('D) 現在の活力度');
                }
            }

            if (errors.length > 0) {
                // エラーサマリ表示
                errorBox.style.display = 'block';
                const header = document.createElement('div');
                header.innerHTML = '<strong>未回答の項目があります。以下を入力・選択してください：</strong>';
                const list = document.createElement('ul');
                errors.forEach(err => {
                    const li = document.createElement('li');
                    li.textContent = err;
                    list.appendChild(li);
                });
                errorBox.appendChild(header);
                errorBox.appendChild(list);

                const firstError = document.querySelector('.error');
                if (firstError && firstError.scrollIntoView) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return; // 送信しない
            }

            // 送信データ構築
            const formData = new FormData(this);
            const data = {
                phase: '{{ phase }}',
                trial: {{ trial }},
                responses: {}
            };
            for (let [key, value] of formData.entries()) {
                data.responses[key] = value;
            }

            console.log('送信データ:', data);

            fetch('/save_questionnaire', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('レスポンスステータス:', response.status);
                return response.json();
            })
            .then(result => {
                console.log('サーバーからの応答:', result);
                if (result.success && result.next_url) {
                    console.log('次のページに遷移:', result.next_url);
                    window.location.href = result.next_url;
                } else if (result.error) {
                    alert('エラー: ' + result.error);
                } else {
                    alert('予期しない応答形式です。');
                    console.error('Unexpected response:', result);
                }
            })
            .catch(error => {
                console.error('Fetch エラー:', error);
                alert('ネットワークエラーが発生しました: ' + error.message);
            });
        });
    });
</script>
{% endblock %}
