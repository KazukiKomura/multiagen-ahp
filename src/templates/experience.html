{% extends "base.html" %} {% block title %}ä½“é¨“ãƒ•ã‚§ãƒ¼ã‚º - æ„æ€æ±ºå®šå®Ÿé¨“ã‚·ã‚¹ãƒ†ãƒ {%
endblock %} {% block content %}
<div class="experience-section">
    <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³èª¬æ˜ãƒãƒŠãƒ¼ -->
    {% if trial == 1 %}
    <div class="session-banner trial-banner">
        <div class="banner-content">
            <h3>ğŸ¯ ç·´ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³</h3>
            <p>
                ã“ã‚Œã¯<strong>ç·´ç¿’</strong>ã§ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®ä½¿ã„æ–¹ã«æ…£ã‚Œã‚‹ãŸã‚ã®ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã™ã€‚<br />
                ã“ã®å¾Œã€ç•°ãªã‚‹å¿œå‹Ÿè€…ã«ã¤ã„ã¦<strong>3å›ã®æœ¬ç•ªã‚»ãƒƒã‚·ãƒ§ãƒ³</strong>ã‚’è¡Œã„ã¾ã™ã€‚
            </p>
        </div>
    </div>
    <!-- ç·´ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å…·ä½“çš„ãªæ¡ˆå†… -->
    <div class="practice-guide">
        <div class="guide-title">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã®å½¹å‰²ã¨æµã‚Œ</div>
        <ul class="guide-list">
            <li>
                <strong>ã‚ãªãŸã¨è¤‡æ•°ã®ä¾¡å€¤åŸºæº–ã‚’æŒã£ãŸAIï¼ˆå‚åŠ è€…ï¼‰3å</strong
                >ãŒå¤§æ‰‹ä¼æ¥­ã®ä¸€æ¬¡é¸è€ƒæ‹…å½“è€…ã§ã™ã€‚ã¾ãšä¸‹ã®å¿œå‹Ÿè€…æƒ…å ±ã‚’èª­ã¿ã€ã€Œä¸€æ¬¡é€šé/è¦‹é€ã‚Šã€ã‚’é¸ã³ã¾ã™ã€‚
            </li>
            <li>
                åˆ¤æ–­ã®æ ¹æ‹ ã¨ã—ã¦ã€<strong>5ã¤ã®åŸºæº–ã®é‡è¦åº¦</strong>ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è¨­å®šã—ã¾ã™ï¼ˆåˆè¨ˆ100%ï¼‰ã€‚
            </li>
            <li>
                ç¶šã„ã¦ã€<strong>ä»–ã®AIï¼ˆAIï¼‰3åã®æ„è¦‹</strong>ã‚’ç¢ºèªã—ã¾ã™ã€‚
            </li>
            <li>
                å¿…è¦ã«å¿œã˜ã¦<strong>æœ€çµ‚åˆ¤å®šã¨é‡è¦åº¦</strong>ã‚’è¦‹ç›´ã—ã€ç¢ºå®šã—ã¦ãã ã•ã„ã€‚
            </li>
        </ul>
        <div class="guide-note">
            ç·´ç¿’ã®ç›®çš„ã¯æ“ä½œã«æ…£ã‚Œã‚‹ã“ã¨ã§ã™ã€‚æœ¬ç•ªã¨åŒã˜æµã‚Œã§é€²ã¿ã¾ã™ãŒã€è½ã¡ç€ã„ã¦æ‰‹é †ã‚’ç¢ºèªã—ãªãŒã‚‰é€²ã‚ã¦ãã ã•ã„ã€‚
        </div>
    </div>
    {% else %}
    <div class="session-banner main-banner">
        <div class="banner-content">
            <h3>âœ¨ æœ¬ç•ªã‚»ãƒƒã‚·ãƒ§ãƒ³ {{ trial - 1 }}/3</h3>
            <p>
                ã“ã‚Œã¯<strong>æœ¬ç•ª</strong>ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã™ã€‚ã‚ãªãŸã®åˆ¤æ–­ãŒç ”ç©¶ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
            </p>
        </div>
    </div>
    <!-- æœ¬ç•ªã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã‚‚å½¹å‰²ã®æ˜è¨˜ã‚’è¡¨ç¤º -->
    <div class="practice-guide">
        <div class="guide-title">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã®å½¹å‰²ã¨æµã‚Œ</div>
        <ul class="guide-list">
            <li>
                <strong>ã‚ãªãŸã¨è¤‡æ•°ã®ä¾¡å€¤åŸºæº–ã‚’æŒã£ãŸAIï¼ˆä»–AIï¼‰</strong
                >ãŒä¸€æ¬¡é¸è€ƒã®æ‹…å½“è€…ã§ã™ã€‚ã¾ãšä¸‹ã®å¿œå‹Ÿè€…æƒ…å ±ã‚’èª­ã¿ã€ã€Œä¸€æ¬¡é€šé/è¦‹é€ã‚Šã€ã‚’é¸ã³ã¾ã™ã€‚
            </li>
            <li>
                åˆ¤æ–­ã®æ ¹æ‹ ã¨ã—ã¦ã€<strong>5ã¤ã®åŸºæº–ã®é‡è¦åº¦</strong>ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è¨­å®šã—ã¾ã™ï¼ˆåˆè¨ˆ100%ï¼‰ã€‚
            </li>
            <li>
                ç¶šã„ã¦ã€<strong>ä»–ã®AIï¼ˆAIï¼‰3åã®æ„è¦‹</strong>ã‚’ç¢ºèªã—ã¾ã™ã€‚
            </li>
            <li>
                å¿…è¦ã«å¿œã˜ã¦<strong>æœ€çµ‚åˆ¤å®šã¨é‡è¦åº¦</strong>ã‚’è¦‹ç›´ã—ã€ç¢ºå®šã—ã¦ãã ã•ã„ã€‚
            </li>
        </ul>
        <div class="guide-note">
            ã“ã®æœ¬ç•ªã®åˆ¤æ–­ã¯ç ”ç©¶ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚è½ã¡ç€ã„ã¦ã€ç´å¾—ã®ã„ãæœ€çµ‚åˆ¤æ–­ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
        </div>
    </div>
    {% endif %}

    <!-- ä¸ŠåŠåˆ†ï¼šå¸¸æ™‚è¡¨ç¤ºã•ã‚Œã‚‹æ„æ€æ±ºå®šæƒ…å ± -->
    <div class="decision-info-panel no-scroll">
        <div class="info-header">
            <h2>{{ info.title }} (ãƒˆãƒ©ã‚¤ã‚¢ãƒ« {{ trial }})</h2>
            <p>{{ info.description }}</p>
        </div>

        <div class="candidate-profile">
            <div class="profile-header">
                <h3>å¿œå‹Ÿè€… {{ info.student.id }} ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
                <div class="basic-info">
                    <span class="info-tag">{{ info.student.major }}</span>
                    <span class="info-tag">{{ info.student.region }}</span>
                    <span class="info-tag"
                        >{{ info.student.institution_rank }}ãƒ•ã‚£ãƒƒãƒˆ</span
                    >
                </div>
            </div>

            <!-- 5ã¤ã®è©•ä¾¡é …ç›®ã‚’æ˜ç¢ºã«è¡¨ç¤º -->
            <div class="evaluation-categories no-scroll">
                <!-- 1. å­¦æ¥­æˆç¸¾ -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸ“š å­¦æ¥­æˆç¸¾</h4>
                    </div>
                    <div class="category-details">
                        <div class="score-large">
                            GPA {{ info.student.gpa }}/4.0
                        </div>
                        <div class="score-bar">
                            <div
                                class="score-fill"
                                style="width: {{ (info.student.gpa / 4.0 * 100) | round | int }}%"
                            ></div>
                        </div>
                        <div class="category-description">
                            å¤§å­¦ã§ã®ç·åˆæˆç¸¾ï¼ˆGPAãƒ»å˜ä½å–å¾—ç‡ï¼‰
                        </div>
                    </div>
                </div>

                <!-- 2. åŸºç¤èƒ½åŠ›ãƒ†ã‚¹ãƒˆ -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸ“ åŸºç¤èƒ½åŠ›ãƒ†ã‚¹ãƒˆ</h4>
                    </div>
                    <div class="category-details">
                        <div class="score-breakdown">
                            <div class="subscore">
                                æ•°ç†:
                                <strong>{{ info.student.gre_quant }}</strong
                                >/170
                            </div>
                            <div class="subscore">
                                è¨€èª:
                                <strong>{{ info.student.gre_verbal }}</strong
                                >/170
                            </div>
                            <div class="subscore">
                                é©æ€§:
                                <strong>{{ info.student.gre_writing }}</strong
                                >/6.0
                            </div>
                        </div>
                        <div class="category-description">
                            Webé©æ€§æ¤œæŸ»ãƒ»SPIç·åˆã‚¹ã‚³ã‚¢
                        </div>
                    </div>
                </div>

                <!-- 3. å®Ÿè·µçµŒé¨“ -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸ’¼ å®Ÿè·µçµŒé¨“</h4>
                    </div>
                    <div class="category-details">
                        <div class="score-breakdown">
                            <div class="subscore">
                                ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³:
                                <strong>{{ info.student.sop_score }}</strong
                                >/5.0
                            </div>
                            <div class="subscore">
                                ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:
                                <strong
                                    >{{ info.student.diversity_score }}</strong
                                >/5.0
                            </div>
                        </div>
                        <div class="score-bar">
                            <div
                                class="score-fill"
                                style="width: {{ (info.student.sop_score / 5 * 100) | round | int }}%"
                            ></div>
                        </div>
                        <div class="category-description">
                            é•·æœŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ãƒ»å®Ÿè·µãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµŒé¨“
                        </div>
                    </div>
                </div>

                <!-- 4. æ¨è–¦ãƒ»è©•ä¾¡ -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸ“„ æ¨è–¦ãƒ»è©•ä¾¡</h4>
                    </div>
                    <div class="category-details">
                        <div class="rec-letters-display">
                            {% for letter in info.student.rec_letters %}
                            <div
                                class="letter-item {{ 'excellent' if 'å„ªç§€' in letter else ('average' if 'æ™®é€š' in letter else 'weak') }}"
                            >
                                {{ letter.replace('æ¨è–¦çŠ¶', 'é¢æ¥è©•ä¾¡') }}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="category-description">
                            é¢æ¥å®˜è©•ä¾¡ãƒ»OBè¨ªå•ãƒ»èª²é¡Œã‚¹ã‚³ã‚¢
                        </div>
                    </div>
                </div>

                <!-- 5. å­¦æ­´ãƒ»æ‰€å±ï¼ˆå¤§å­¦æ‰€å±ã®æ–‡è„ˆã«åˆã‚ã›ã¦è¡¨è¨˜ï¼‰ -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸ« å­¦æ­´ãƒ»æ‰€å±</h4>
                    </div>
                    <div class="category-details">
                        <div class="score-large">
                            {{ info.student.diversity_score }}/5.0
                        </div>
                        <div class="diversity-info">
                            <div class="diversity-item">
                                å°‚æ”»: <strong>{{ info.student.major }}</strong>
                            </div>
                            <div class="diversity-item">
                                å‡ºèº«:
                                <strong>{{ info.student.region }}</strong>
                            </div>
                            <div class="diversity-item">
                                ãƒ©ãƒ³ã‚¯:
                                <strong
                                    >{{ info.student.institution_rank }}</strong
                                >
                            </div>
                        </div>
                        <div class="category-description">
                            å­¦æ­´ãƒ»æ‰€å±ã«é–¢ã™ã‚‹æƒ…å ±
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸‹åŠåˆ†ï¼šæ“ä½œãƒ•ã‚§ãƒ¼ã‚ºåˆ‡ã‚Šæ›¿ãˆã‚¨ãƒªã‚¢ -->
    <div class="operation-panel">
        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º -->
        <div class="progress-bar">
            <div class="step active" data-step="0">
                <span class="step-number">1</span>
                <span class="step-label">ã‚ãªãŸã®æ„è¦‹</span>
            </div>
            <div class="step" data-step="1">
                <span class="step-number">2</span>
                <span class="step-label">ä»–ã®æ„è¦‹ç¢ºèª</span>
            </div>
            <div class="step" data-step="2">
                <span class="step-number">3</span>
                <span class="step-label">AIãƒãƒ£ãƒƒãƒˆ</span>
            </div>
            <div class="step" data-step="3">
                <span class="step-number">4</span>
                <span class="step-label">æœ€çµ‚æ±ºå®š</span>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º1: è‡ªåˆ†ã®æ„è¦‹è¡¨æ˜ -->
        <div class="phase-content active no-scroll" data-phase="0">
            <h3>ã‚ãªãŸã®æ„è¦‹ã‚’ãŠèã‹ã›ãã ã•ã„</h3>
            <form
                id="initialDecisionForm"
                method="post"
                action="javascript:void(0);"
            >
                <div class="decision-choice">
                    <h4>
                        ä¸€æ¬¡é¸è€ƒçµæœã‚’ãŠé¸ã³ãã ã•ã„
                        <span class="required">*å¿…é ˆ</span>
                    </h4>
                    <div class="radio-group simple-options">
                        <label>
                            <input
                                type="radio"
                                name="decision"
                                value="ä¸€æ¬¡é€šé"
                                required
                            />
                            <span class="radio-custom"></span>
                            ä¸€æ¬¡é€šé
                        </label>
                        <label>
                            <input
                                type="radio"
                                name="decision"
                                value="è¦‹é€ã‚Š"
                                required
                            />
                            <span class="radio-custom"></span>
                            è¦‹é€ã‚Š
                        </label>
                    </div>
                </div>

                <div class="weights-section no-scroll">
                    <h4>
                        ãªãœä¸Šè¨˜ã®æ±ºæ–­ã‚’ã—ã¾ã—ãŸ?æ±ºæ–­ã§é‡è¦–ã—ãŸåŸºæº–ã‚’ä»¥ä¸‹ã§è¨­å®šã—ã¦ãã ã•ã„ï¼ˆåˆè¨ˆ100%ï¼‰
                    </h4>
                    <div class="weights-container no-scroll">
                        {% set initial_weight = (100 /
                        info.criteria|length)|round|int %} {% for criterion in
                        info.criteria %}
                        <div class="weight-item">
                            {% set display_label = 'å­¦æ­´ãƒ»æ‰€å±' if criterion == 'å¿—æœ›å‹•æ©Ÿãƒ»ãƒ•ã‚£ãƒƒãƒˆ' else criterion %}
                            <label for="{{ criterion }}">{{ display_label }}</label>
                            <div class="weight-controls">
                                <input
                                    type="range"
                                    id="{{ criterion }}"
                                    name="{{ criterion }}"
                                    min="0"
                                    max="100"
                                    value="{{ initial_weight }}"
                                    step="10"
                                    class="weight-slider"
                                />
                                <span
                                    class="weight-value"
                                    id="{{ criterion }}-value"
                                    >{{ initial_weight }}</span
                                >%
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="total-weight">
                        åˆè¨ˆ: <span id="total-weight">100</span>%
                    </div>
                    <div
                        id="equal-weights-warning"
                        class="warning-message"
                        style="display: none"
                    >
                        âš ï¸
                        å…¨ã¦ã®åŸºæº–ãŒåŒã˜é‡ã¿ã«ãªã£ã¦ã„ã¾ã™ã€‚ç•°ãªã‚‹é‡è¦åº¦ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
                    </div>
                </div>

                <button
                    type="button"
                    class="btn btn-primary"
                    id="confirmDecisionBtn"
                >
                    æ„è¦‹ã‚’ç¢ºå®šã—ã¦æ¬¡ã¸
                </button>
            </form>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º2: ä»–ã®æ„è¦‹ç¢ºèª -->
        <div class="phase-content no-scroll" data-phase="1">
            <h3>ä»–ã®AIã®æ„è¦‹</h3>
            <div class="section-help">
                ã‚ãªãŸã®åˆå›åˆ¤æ–­ã¨é‡ã¿ã‚’ã€ä¾¡å€¤åŸºæº–ã®ç•°ãªã‚‹AIï¼ˆ3åï¼‰ã®åˆ¤æ–­ãƒ»é‡ã¿ã¨ä¸¦ã¹ã¦æ¯”è¼ƒã™ã‚‹ãƒšãƒ¼ã‚¸ã§ã™ã€‚é•ã„ã‚’æŠŠæ¡ã—ã€æ¬¡ãƒšãƒ¼ã‚¸ä»¥é™ã®å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
            </div>
            <div class="opinions-comparison no-scroll">
                <div class="my-opinion no-scroll">
                    <h4>ã‚ãªãŸã®æ„è¦‹</h4>
                    <div class="opinion-summary" id="myOpinionSummary">
                        <!-- JavaScript ã§å‹•çš„ã«è¡¨ç¤º -->
                    </div>
                </div>

                <div class="others-opinions no-scroll">
                    <h4>ä»–ã®AIã®æ„è¦‹</h4>
                    <div class="opinions-grid no-scroll" id="othersOpinions">
                        <!-- JavaScript ã§å‹•çš„ã«è¡¨ç¤º -->
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="nextPhase()">
                AIãƒãƒ£ãƒƒãƒˆã¸é€²ã‚€
            </button>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º3: AIãƒãƒ£ãƒƒãƒˆ -->
        <div class="phase-content" data-phase="2">
            <h3 id="ai-chat-title">AIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã¨ã®å¯¾è©±</h3>
            <div class="ai-rules-notice">
                <div class="rules-title">ã€æ‰‹ç¶šã¨ãƒ«ãƒ¼ãƒ«ã®ã”æ¡ˆå†…ã€‘</div>
                <div class="rules-section">
                    <div class="rules-subtitle">
                        æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦è©•ä¾¡ã‚’è¡Œã„ã¾ã™ï¼š
                    </div>
                    <div class="rules-subheading">è©•ä¾¡åŸºæº–</div>
                    <ul>
                        <li>ã“ã®å¾Œæœ€çµ‚æ„æ€æ±ºå®šã‚’ã—ãŸå¾Œã®å¤šæ•°æ±º</li>
                    </ul>

                    <div class="rules-subheading">ä»Šå¾Œã®æµã‚Œ</div>
                    <ol>
                        <li>
                            ä»¥ä¸‹ã§ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ã‹ã‚‰è³ªå•ã‚’è¡Œã„ã€æ„è¦‹ã‚’æ•´ç†ã™ã‚‹
                        </li>
                        <li>å¿…è¦ã«å¿œã˜ã¦ä»–ã®å‚åŠ è€…AIã¸ã®ç•°è­°ç”³ã—ç«‹ã¦ãŒå¯èƒ½</li>
                        <li>
                            ä¼šè©±ã‚’<strong
                                >æœ€ä½4å›ä»¥ä¸Šç¹°ã‚Šè¿”ã—ãŸã®ã¡ã«ã€æœ€çµ‚çµæœã‚’æ¬¡ãƒšãƒ¼ã‚¸ã§ç¢ºå®š</strong
                            >
                        </li>
                    </ol>
                </div>
            </div>
            <div class="split-view">
                <div class="opinions-sidebar">
                    <h4>æ„è¦‹ã®æ¯”è¼ƒ</h4>
                    <div id="comparisonView">
                        <!-- JavaScript ã§å‹•çš„ã«è¡¨ç¤º -->
                    </div>
                </div>
                <div class="chat-area">
                    <div class="chat-messages" id="chatMessages">
                        <!-- AIåˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
                    </div>
                    <div
                        class="loading-indicator"
                        id="loadingIndicator"
                        style="display: none"
                    >
                        <div class="loading-spinner"></div>
                        <div class="loading-text">
                            AIãŒå›ç­”ã‚’è€ƒãˆã¦ã„ã¾ã™...
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input
                            type="text"
                            id="chatInput"
                            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                            maxlength="500"
                        />
                        <button id="sendButton" class="btn btn-primary">
                            é€ä¿¡
                        </button>
                    </div>
                    <div class="chat-info">
                        <p>
                            ä¼šè©±å›æ•°:
                            <span id="messageCount">0</span>ï¼ˆæœ€ä½4å›ï¼‰
                        </p>
                        <button
                            class="btn btn-secondary"
                            id="finishChat"
                            style="display: none"
                            onclick="nextPhase()"
                        >
                            å¯¾è©±ã‚’çµ‚äº†ã—ã¦æœ€çµ‚æ±ºå®šã¸
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º4: æœ€çµ‚æ±ºå®š -->
        <div class="phase-content" data-phase="3">
            <h3>æœ€çµ‚æ±ºå®š</h3>
            <div class="final-guide">
                <div class="guide-title">ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§è¡Œã†ã“ã¨</div>
                <ul class="guide-list">
                    <li>ä¸‹ã®ã€Œåˆå›ã®åˆ¤æ–­ã€ã‚’ç¢ºèª</li>
                    <li>å¿…è¦ãªã‚‰ã€Œæœ€çµ‚åˆ¤å®šã€ã‚’å¤‰æ›´</li>
                    <li>é‡ã¿ã‚’å¾®èª¿æ•´ï¼ˆåˆè¨ˆ100%ï¼‰</li>
                    <li>å¤‰æ›´ç†ç”±ï¼ˆä»»æ„ï¼‰ã¨ä¿¡é ¼åº¦ã‚’å…¥åŠ›</li>
                    <li>ã€Œæœ€çµ‚æ±ºå®šã‚’ç¢ºå®šã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                </ul>
                <div class="guide-note">
                    æå‡ºå¾Œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ã€‚æ…é‡ã«ã”ç¢ºèªãã ã•ã„ã€‚
                </div>
            </div>
            <div class="final-decision-area">
                <div class="decision-comparison">
                    <div class="initial-decision">
                        <h4>åˆå›ã®åˆ¤æ–­</h4>
                        <div id="initialDecisionSummary">
                            <!-- JavaScript ã§å‹•çš„ã«è¡¨ç¤º -->
                        </div>
                    </div>
                </div>

                <form
                    id="finalDecisionForm"
                    method="post"
                    action="javascript:void(0);"
                >
                    <div class="final-choice">
                        <h4>æœ€çµ‚åˆ¤å®š</h4>
                        <div class="radio-group simple-options">
                            <label>
                                <input
                                    type="radio"
                                    name="final_decision"
                                    value="ä¸€æ¬¡é€šé"
                                    required
                                />
                                <span class="radio-custom"></span>
                                ä¸€æ¬¡é€šé
                            </label>
                            <label>
                                <input
                                    type="radio"
                                    name="final_decision"
                                    value="è¦‹é€ã‚Š"
                                    required
                                />
                                <span class="radio-custom"></span>
                                è¦‹é€ã‚Š
                            </label>
                        </div>
                    </div>

                    <div class="final-weights">
                        <h4>æœ€çµ‚é‡è¦åº¦è¨­å®š</h4>
                        <p class="hint-text">
                            åˆå›ã®é‡ã¿ã‚’åˆæœŸå€¤ã¨ã—ã¦èª­ã¿è¾¼ã¿æ¸ˆã¿ã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†å¾®èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
                        </p>
                        <div class="weights-container">
                            {% set final_initial_weight = (100 /
                            info.criteria|length)|round|int %} {% for criterion
                            in info.criteria %}
                            <div class="weight-item">
                                {% set display_label = 'å­¦æ­´ãƒ»æ‰€å±' if criterion == 'å¿—æœ›å‹•æ©Ÿãƒ»ãƒ•ã‚£ãƒƒãƒˆ' else criterion %}
                                <label for="final_{{ criterion }}">{{ display_label }}</label>
                                <div class="weight-controls">
                                    <input
                                        type="range"
                                        id="final_{{ criterion }}"
                                        name="final_{{ criterion }}"
                                        min="0"
                                        max="100"
                                        value="{{ final_initial_weight }}"
                                        step="10"
                                        class="weight-slider final-slider"
                                    />
                                    <span
                                        class="weight-value"
                                        id="final_{{ criterion }}-value"
                                        >{{ final_initial_weight }}</span
                                    >%
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="total-weight">
                            åˆè¨ˆ: <span id="final-total-weight">100</span>%
                        </div>
                    </div>

                    <div class="change-reasoning">
                        <h4>å¤‰æ›´ç†ç”±ï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰</h4>
                        <textarea
                            name="change_reasoning"
                            rows="3"
                            placeholder="åˆ¤æ–­ã‚„é‡è¦åº¦ã‚’å¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ãã®ç†ç”±ã‚’ãŠèã‹ã›ãã ã•ã„"
                        ></textarea>
                    </div>

                    <div class="confidence-rating">
                        <h4>æœ€çµ‚åˆ¤æ–­ã¸ã®ä¿¡é ¼åº¦</h4>
                        <div class="scale-input">
                            <input
                                type="range"
                                id="confidence"
                                name="confidence"
                                min="1"
                                max="7"
                                value="4"
                                class="slider"
                            />
                            <div class="scale-labels">
                                <span>å…¨ãä¿¡é ¼ã—ã¦ã„ãªã„</span>
                                <span class="scale-value" id="confidence-value"
                                    >4</span
                                >
                                <span>å®Œå…¨ã«ä¿¡é ¼ã—ã¦ã„ã‚‹</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        æœ€çµ‚æ±ºå®šã‚’ç¢ºå®šã™ã‚‹
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<style>
    /* AIãƒãƒ£ãƒƒãƒˆæ³¨æ„äº‹é … */
    .ai-rules-notice {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-left: 4px solid #0ea5e9;
        padding: 12px 14px;
        border-radius: 8px;
        margin: 8px 0 14px;
        color: #374151;
    }
    .ai-rules-notice .rules-title {
        font-weight: 700;
        margin-bottom: 6px;
        color: #1f2937;
    }
    .ai-rules-notice .rules-subtitle {
        font-weight: 600;
        margin: 6px 0 4px;
    }
    .ai-rules-notice .rules-subheading {
        font-weight: 600;
        margin-top: 6px;
    }
    .ai-rules-notice ul {
        margin: 4px 0 6px 18px;
    }
    .ai-rules-notice ol {
        margin: 4px 0 6px 18px;
    }
    /* ç·´ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¡ˆå†…ã®è»½é‡ã‚¹ã‚¿ã‚¤ãƒ« */
    .practice-guide {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-left: 4px solid #3b82f6;
        padding: 12px 16px;
        border-radius: 8px;
        margin: 12px 0 20px;
    }
    .practice-guide .guide-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 6px;
    }
    .practice-guide .guide-list {
        margin: 6px 0 8px 18px;
        color: #374151;
    }
    .practice-guide .guide-list li {
        margin: 4px 0;
        line-height: 1.5;
    }
    .practice-guide .guide-note {
        color: #4b5563;
        font-size: 0.9em;
    }
    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç°¡æ˜“èª¬æ˜ */
    .section-help {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 8px 10px;
        margin: 6px 0 12px;
        color: #374151;
        font-size: 0.95em;
    }
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®ä½™ç™½ï¼ˆè¦‹å‡ºã—ãŒä¸Šã«è²¼ã‚Šä»˜ã‹ãªã„ã‚ˆã†ã«ï¼‰ */
    #ai-chat-title {
        scroll-margin-top: 24px;
    }
    /* Loading indicator styles */
    /* Final decision guidance */
    .final-guide {
        background: #f8f9ff;
        border: 1px solid #e0e7ff;
        border-radius: 8px;
        padding: 12px 14px;
        margin: 8px 0 16px;
    }
    .final-guide .guide-title {
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
    }
    .final-guide .guide-list {
        margin: 6px 0 8px 18px;
    }
    .final-guide .guide-list li {
        margin: 2px 0;
    }
    .final-guide .guide-note {
        font-size: 12px;
        color: #6b7280;
    }
    .hint-text {
        color: #6b7280;
        font-size: 13px;
        margin: 6px 0 10px;
    }
    .loading-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin: 10px 0;
        border: 1px solid #e9ecef;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e9ecef;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    .loading-text {
        color: #6c757d;
        font-size: 14px;
        font-style: italic;
    }

    /* Markdown styles inside bubbles */
    .chat-messages .message-content h1,
    .chat-messages .message-content h2,
    .chat-messages .message-content h3 {
        margin: 6px 0 4px;
    }
    .chat-messages .message-content p {
        margin: 6px 0;
    }
    .chat-messages .message-content ul,
    .chat-messages .message-content ol {
        margin: 6px 0 6px 18px;
    }
    .chat-messages .message-content code {
        background: #f6f8fa;
        padding: 0 3px;
        border-radius: 4px;
    }
    .chat-messages .message-content pre {
        background: #f6f8fa;
        padding: 8px;
        border-radius: 6px;
        overflow-x: auto;
    }
    .chat-messages .message-content a {
        color: #0d6efd;
        text-decoration: underline;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    /* Chat input disabled state */
    .chat-input-container.loading input {
        opacity: 0.6;
        pointer-events: none;
    }

    .chat-input-container.loading button {
        opacity: 0.6;
        pointer-events: none;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('âœ“ DOMContentLoaded event fired');

        // ãƒ‡ãƒãƒƒã‚°: å…¨ä½“çš„ãªè¦ç´ ç¢ºèª
        const allForms = document.querySelectorAll('form');
        console.log('âœ“ ãƒšãƒ¼ã‚¸å†…ã®ãƒ•ã‚©ãƒ¼ãƒ æ•°:', allForms.length);

        const allButtons = document.querySelectorAll('button');
        console.log('âœ“ ãƒšãƒ¼ã‚¸å†…ã®ãƒœã‚¿ãƒ³æ•°:', allButtons.length);

        allButtons.forEach((btn, index) => {
            console.log(`  ãƒœã‚¿ãƒ³${index}: id="${btn.id}", type="${btn.type}", text="${btn.textContent.trim()}"`);
        });

        let currentPhase = 0;
        let initialDecisionData = null;
        let botOpinions = [];
        const criteriaOrder = {{ info.criteria | tojson }}; // è¡¨ç¤ºé †åºã‚’å›ºå®š
    let conversationCount = 0;

    // è¡¨ç¤ºåã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆUIæ–‡è¨€ã®æ•´åˆï¼‰
    function displayName(c) {
        return c === 'å¿—æœ›å‹•æ©Ÿãƒ»ãƒ•ã‚£ãƒƒãƒˆ' ? 'å­¦æ­´ãƒ»æ‰€å±' : c;
    }

        // --- Chat message rendering helpers (newline + lightweight Markdown) ---
        function escapeHtml(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderMarkdown(src) {
            if (!src) return '';
            // Preserve code blocks first
            const blocks = [];
            let text = src.replace(/```([\s\S]*?)```/g, function(_, code) {
                blocks.push('<pre><code>' + escapeHtml(code.trim()) + '</code></pre>');
                return '@@BLOCK' + (blocks.length - 1) + '@@';
            });

            text = escapeHtml(text);

            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Links [text](url)
            text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^)\s]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            // Bold/Italic (process bold first)
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // Headings (at line starts)
            text = text.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>')
                       .replace(/^##\s+(.+)$/gm, '<h2>$1</h2>')
                       .replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');

            // Lists
            text = text.replace(/(^|\n)(?:\s*[-\*]\s+.+(?:\n\s*[-\*]\s+.+)*)/g, function(m) {
                var items = m.trim().split(/\n/).map(function(line){ return line.replace(/^\s*[-\*]\s+/, ''); }).map(function(li){ return '<li>' + li + '</li>'; }).join('');
                return '\n<ul>' + items + '</ul>';
            });
            text = text.replace(/(^|\n)(?:\s*\d+\.\s+.+(?:\n\s*\d+\.\s+.+)*)/g, function(m) {
                var items = m.trim().split(/\n/).map(function(line){ return line.replace(/^\s*\d+\.\s+/, ''); }).map(function(li){ return '<li>' + li + '</li>'; }).join('');
                return '\n<ol>' + items + '</ol>';
            });

            // Paragraphs and line breaks
            var parts = text.split(/\n\n+/).map(function(p){ return '<p>' + p.replace(/\n/g, '<br>') + '</p>'; });
            var html = parts.join('');

            // Restore code blocks
            html = html.replace(/@@BLOCK(\d+)@@/g, function(_, i){ return blocks[Number(i)] || ''; });
            return html;
        }

        // å‹•çš„ãƒœãƒƒãƒˆæ„è¦‹ç”Ÿæˆé–¢æ•°
        function generateBotOpinions(userDecision, userWeights, criteriaList) {
            const trial = {{ trial }};
            const botOpinions = [];

            // ãƒ©ãƒ³ãƒ€ãƒ ãªé‡ã¿ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆ10%åˆ»ã¿ã€åˆè¨ˆ100%ï¼‰
            function generateRandomWeights(criteriaList) {
                const numCriteria = criteriaList.length;
                let weights = {};
                let remaining = 100;

                // æœ€å¾Œã®åŸºæº–ä»¥å¤–ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«å‰²ã‚Šå½“ã¦
                for (let i = 0; i < numCriteria - 1; i++) {
                    const criterion = criteriaList[i];
                    const maxWeight = Math.min(remaining - (numCriteria - i - 1) * 10, 70); // æœ€ä½10%ã‚’ä»–ã«æ®‹ã™
                    const minWeight = Math.max(10, remaining - (numCriteria - i - 1) * 70); // æœ€ä½10%ã¯å‰²ã‚Šå½“ã¦
                    const weight = Math.floor(Math.random() * ((maxWeight - minWeight) / 10 + 1)) * 10 + minWeight;
                    weights[criterion] = weight;
                    remaining -= weight;
                }

                // æœ€å¾Œã®åŸºæº–ã«ã¯æ®‹ã‚Šã‚’å‰²ã‚Šå½“ã¦
                weights[criteriaList[numCriteria - 1]] = remaining;

                return weights;
            }

            // ç·´ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å ´åˆã¯å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ã€æœ¬ç•ªã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åå¯¾
            function getBotDecision() {
                if (trial === 1) {
                    // ç·´ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³: å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ 
                    return Math.random() < 0.5 ? 'ä¸€æ¬¡é€šé' : 'è¦‹é€ã‚Š';
                } else {
                    // æœ¬ç•ªã‚»ãƒƒã‚·ãƒ§ãƒ³: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åå¯¾
                    return userDecision === 'ä¸€æ¬¡é€šé' ? 'è¦‹é€ã‚Š' : 'ä¸€æ¬¡é€šé';
                }
            }

            // AI3åã®æ„è¦‹ã‚’ç”Ÿæˆï¼ˆç·´ç¿’ã§ã¯2-2ã‚’é¿ã‘ã‚‹ï¼‰
            const decisions = [];

            if (trial === 1) {
                // ç·´ç¿’: 2åã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
                decisions.push(getBotDecision());
                decisions.push(getBotDecision());

                // 3åç›®ã¯2-2ã‚’é¿ã‘ã‚‹ã‚ˆã†èª¿æ•´
                const userChoice = userDecision;
                const userCount = userChoice === 'ä¸€æ¬¡é€šé' ? 1 : 0;
                const participantPassCount = decisions.filter(d => d === 'ä¸€æ¬¡é€šé').length;
                const totalPassCount = userCount + participantPassCount;

                if (totalPassCount === 2) {
                    // 2-2ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€3åç›®ã§èª¿æ•´
                    decisions.push(userChoice === 'ä¸€æ¬¡é€šé' ? 'è¦‹é€ã‚Š' : 'ä¸€æ¬¡é€šé');
                } else {
                    // 2-2ã«ãªã‚‰ãªã„ã®ã§ã€3åç›®ã¯ãƒ©ãƒ³ãƒ€ãƒ 
                    decisions.push(getBotDecision());
                }
            } else {
                // æœ¬ç•ª: å…¨å“¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå¯¾
                const opposite = userDecision === 'ä¸€æ¬¡é€šé' ? 'è¦‹é€ã‚Š' : 'ä¸€æ¬¡é€šé';
                decisions.push(opposite, opposite, opposite);
            }

            // AI1-3ã®ç”Ÿæˆ
            for (let i = 0; i < 3; i++) {
                botOpinions.push({
                    bot_id: i,
                    decision: decisions[i],
                    weights: generateRandomWeights(criteriaList)
                });
            }

            return botOpinions;
        }

        // é‡è¦åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼é–¢æ•°
        function setupWeightSliders(containerSelector) {
            const container = document.querySelector(containerSelector);
            const weightSliders = container.querySelectorAll('.weight-slider');
            const totalWeightDisplay = container.querySelector('.total-weight span');

            function updateWeights() {
                let total = 0;
                const weights = [];
                weightSliders.forEach(slider => {
                    const value = parseInt(slider.value);
                    total += value;
                    weights.push(value);
                    document.getElementById(slider.id + '-value').textContent = value;
                });

                totalWeightDisplay.textContent = total;
                totalWeightDisplay.className = total === 100 ? 'correct' : 'incorrect';

                // åŒä¸€é‡ã¿è­¦å‘Šã®è¡¨ç¤º/éè¡¨ç¤º
                const allSame = weights.every(w => w === weights[0]);
                const warningElement = container.querySelector('#equal-weights-warning');
                if (warningElement) {
                    warningElement.style.display = allSame ? 'block' : 'none';
                }
            }

            weightSliders.forEach(slider => {
                slider.addEventListener('input', updateWeights);
            });

            updateWeights();
            return { weightSliders, updateWeights };
        }

        // main.jsã®é‡è¤‡ã™ã‚‹é‡ã¿è¨ˆç®—ã‚’ç„¡åŠ¹åŒ–
        window.updateWeightTotal = function() {
            // experience.htmlå†…ã®é‡ã¿ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€main.jsã®é–¢æ•°ã‚’ç„¡åŠ¹åŒ–
        };

        // åˆæœŸé‡è¦åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®š
        const initialWeights = setupWeightSliders('[data-phase="0"]');

        // ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡ã‚Šæ›¿ãˆ
        function showPhase(phaseIndex) {
            document.querySelectorAll('.phase-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });

            document.querySelector(`[data-phase="${phaseIndex}"]`).classList.add('active');
            document.querySelector(`[data-step="${phaseIndex}"]`).classList.add('active');

            currentPhase = phaseIndex;

        if (phaseIndex === 2) {
            // AIãƒãƒ£ãƒƒãƒˆãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã«æ‰‹ç¶šãèª¬æ˜ã‚’å–å¾—
            initializeChat();
            // è¦‹å‡ºã—ä½ç½®ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆãƒãƒ£ãƒƒãƒˆã®é€”ä¸­ã‹ã‚‰å§‹ã¾ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
            setTimeout(() => {
                const anchor = document.getElementById('ai-chat-title');
                if (anchor && typeof anchor.scrollIntoView === 'function') {
                    anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        } else if (phaseIndex === 3) {
                // æœ€çµ‚æ±ºå®šãƒ•ã‚§ãƒ¼ã‚ºã®é‡è¦åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®š
                setTimeout(() => {
                    const finalWeights = setupWeightSliders('[data-phase="3"]');
                    // åˆæœŸå€¤ã‚’è¨­å®š
                    if (initialDecisionData) {
                        Object.entries(initialDecisionData.weights).forEach(([criterion, weight]) => {
                            const slider = document.getElementById(`final_${criterion}`);
                            if (slider) {
                                slider.value = weight;
                            }
                        });
                        finalWeights.updateWeights();

                        // åˆå›ã®åˆ¤æ–­ã‚’æœ€çµ‚åˆ¤æ–­ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
                        try {
                            const val = initialDecisionData.decision;
                            const radio = document.querySelector(`input[name="final_decision"][value="${val}"]`);
                            if (radio) radio.checked = true;
                        } catch (e) {
                            console.warn('æœ€çµ‚åˆ¤æ–­ãƒ©ã‚¸ã‚ªã®åˆæœŸåŒ–ã«å¤±æ•—:', e);
                        }
                    }
                    // åˆå›ã®åˆ¤æ–­ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
                    try { updateInitialDecisionSummary(); } catch (e) { console.warn('åˆå›åˆ¤æ–­ã‚µãƒãƒªãƒ¼æ›´æ–°å¤±æ•—', e); }
                }, 100);
            }
        }

        window.nextPhase = function() {
            if (currentPhase < 3) {
                showPhase(currentPhase + 1);
            }
        };

        // ãƒ•ã‚§ãƒ¼ã‚º1: åˆæœŸæ±ºå®šãƒœã‚¿ãƒ³
        const confirmBtn = document.getElementById('confirmDecisionBtn');
        const initialForm = document.getElementById('initialDecisionForm');

        if (!confirmBtn || !initialForm) {
            console.error('confirmDecisionBtn ã¾ãŸã¯ initialDecisionForm ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        console.log('âœ“ æ„è¦‹ç¢ºå®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');

        confirmBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('âœ“ æ„è¦‹ç¢ºå®šãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            console.log('  ã‚¤ãƒ™ãƒ³ãƒˆ:', e);
            console.log('  ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ :', initialForm);

            // åˆ¤å®šã®é¸æŠã‚’ãƒã‚§ãƒƒã‚¯
            const decisionSelected = document.querySelector('input[name="decision"]:checked');
            if (!decisionSelected) {
                alert('ä¸€æ¬¡é€šéã¾ãŸã¯è¦‹é€ã‚Šã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const total = parseInt(document.getElementById('total-weight').textContent);
            if (total !== 100) {
                alert('é‡è¦åº¦ã®åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®åˆè¨ˆ: ' + total + '%');
                return;
            }

            // å…¨ã¦åŒã˜é‡ã¿ã‹ãƒã‚§ãƒƒã‚¯
            const weightSliders = document.querySelectorAll('.weight-slider');
            const weights = Array.from(weightSliders).map(slider => parseInt(slider.value));
            const allSame = weights.every(w => w === weights[0]);

            if (allSame) {
                const confirmed = confirm('å…¨ã¦ã®åŸºæº–ãŒåŒã˜é‡ã¿ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾é€²ã‚“ã§ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
                if (!confirmed) {
                    return;
                }
            }

            const formData = new FormData(initialForm);

            console.log('ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å†…å®¹ç¢ºèª:');
            for (let [key, value] of formData.entries()) {
                console.log('  ' + key + ': ' + value);
            }

            const data = {
                trial: parseInt('{{ trial }}'),
                decision: formData.get('decision'),
                weights: {},
                reasoning: formData.get('reasoning') || '',
                timestamp: new Date().toISOString()
            };

            // åŸºæº–ã®é‡ã¿ã‚’å–å¾—
            const criteria = {{ info.criteria | tojson }};
            criteria.forEach(criterion => {
                const criterionValue = parseInt(formData.get(criterion));
                data.weights[criterion] = isNaN(criterionValue) ? 0 : criterionValue;
                console.log('é‡ã¿ - ' + criterion + ':', data.weights[criterion]);
            });

            initialDecisionData = data;

            console.log('æ„æ€æ±ºå®šãƒ‡ãƒ¼ã‚¿é€ä¿¡:', data);

            fetch('/save_decision', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                return response.json();
            })
            .then(result => {
                console.log('ã‚µãƒ¼ãƒãƒ¼å¿œç­”:', result);
                if (result.success) {
                    // ã‚µãƒ¼ãƒã§ç¢ºå®šã—ãŸAIæ„è¦‹ã‚’æ¡ç”¨
                    if (Array.isArray(result.participant_opinions)) {
                        botOpinions = result.participant_opinions;
                    }
                    console.log('ç¢ºå®šã•ã‚ŒãŸAIæ„è¦‹:', botOpinions);
                    // ç›´æ¥æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸é€²ã‚€
                    showPhase1Content();
                    nextPhase();
                } else if (result.error) {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                } else {
                    alert('äºˆæœŸã—ãªã„å¿œç­”å½¢å¼ã§ã™ã€‚');
                    console.error('Unexpected response:', result);
                }
            })
            .catch(error => {
                console.error('Fetch ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            });
        });

        // ãƒ•ã‚§ãƒ¼ã‚º2è¡¨ç¤ºå†…å®¹æ›´æ–°
        function showPhase1Content() {
            // è‡ªåˆ†ã®æ„è¦‹è¡¨ç¤º
            const myOpinionSummary = document.getElementById('myOpinionSummary');
            const myDecisionText = initialDecisionData.decision; // ç›´æ¥è¡¨ç¤ºï¼ˆã™ã§ã«ã€Œä¸€æ¬¡é€šéã€ã€Œè¦‹é€ã‚Šã€ï¼‰
            const myDecisionClass = initialDecisionData.decision === 'ä¸€æ¬¡é€šé' ? 'pass' : 'fail';

            myOpinionSummary.innerHTML = `
                <div class="decision-badge ${myDecisionClass}">
                    ${myDecisionText}
                </div>
                <div class="weight-bars">
                    ${Object.entries(initialDecisionData.weights).map(([criterion, weight]) => `
                        <div class="weight-bar-small">
                            <span class="criterion">${displayName(criterion)}:</span>
                            <div class="bar">
                                <div class="fill" style="width: ${weight}%"></div>
                            </div>
                            <span class="value">${weight}%</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // ä»–ã®AIã®æ„è¦‹è¡¨ç¤º
            const othersOpinions = document.getElementById('othersOpinions');
            othersOpinions.innerHTML = botOpinions.map(opinion => {
                // æ±ºå®šã¯æ—¢ã«ä¸€æ¬¡é€šé/è¦‹é€ã‚Šã®å½¢å¼
                const decisionText = opinion.decision;
                const decisionClass = opinion.decision === 'ä¸€æ¬¡é€šé' ? 'pass' : 'fail';

                return `
                <div class="opinion-card">
                    <h5>AI ${opinion.bot_id + 1}</h5>
                    <div class="decision-badge ${decisionClass}">
                        ${decisionText}
                    </div>
                    <div class="weight-bars">
                        ${criteriaOrder.map((criterion) => {
                            const weight = opinion.weights[criterion] ?? 0;
                            const roundedWeight = Math.round(weight / 10) * 10;
                            return `
                            <div class="weight-bar-small">
                                <span class="criterion">${displayName(criterion)}:</span>
                                <div class="bar">
                                    <div class="fill" style="width: ${roundedWeight}%"></div>
                                </div>
                                <span class="value">${roundedWeight}%</span>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                `;
            }).join('');

            // ãƒ•ã‚§ãƒ¼ã‚º3ã®æ¯”è¼ƒè¡¨ç¤ºã‚‚æ›´æ–°
            updateComparisonView();
        }

        function updateComparisonView() {
            const comparisonView = document.getElementById('comparisonView');

            // è‡ªåˆ†ã®æ±ºå®šã‚’åˆæ ¼/ä¸åˆæ ¼ã«å¤‰æ›
            const myDecisionText = initialDecisionData.decision; // ç›´æ¥è¡¨ç¤ºï¼ˆã™ã§ã«ã€Œä¸€æ¬¡é€šéã€ã€Œè¦‹é€ã‚Šã€ï¼‰
            const myDecisionClass = initialDecisionData.decision === 'ä¸€æ¬¡é€šé' ? 'pass' : 'fail';

            comparisonView.innerHTML = `
                <div class="comparison-item">
                    <h5>ã‚ãªãŸã®æ„è¦‹</h5>
                    <div class="decision-badge ${myDecisionClass}">
                        ${myDecisionText}
                    </div>
                    <div class="weight-bars-mini">
                        ${criteriaOrder.map((criterion) => {
                            const weight = initialDecisionData.weights[criterion] ?? 0;
                            return `
                            <div class="weight-bar-mini">
                                <span class="criterion-mini">${displayName(criterion)}:</span>
                                <div class="bar-mini">
                                    <div class="fill-mini" style="width: ${weight}%"></div>
                                </div>
                                <span class="value-mini">${weight}%</span>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ${botOpinions.map(opinion => {
                    const decisionText = opinion.decision;
                    const decisionClass = opinion.decision === 'ä¸€æ¬¡é€šé' ? 'pass' : 'fail';
                    return `
                    <div class="comparison-item">
                        <h5>AI ${opinion.bot_id + 1}</h5>
                        <div class="decision-badge ${decisionClass}">
                            ${decisionText}
                        </div>
                        <div class="weight-bars-mini">
                            ${criteriaOrder.map((criterion) => {
                                const weight = opinion.weights[criterion] ?? 0;
                                const roundedWeight = Math.round(weight / 10) * 10;
                                return `
                                <div class="weight-bar-mini">
                                    <span class="criterion-mini">${displayName(criterion)}:</span>
                                    <div class="bar-mini">
                                        <div class="fill-mini" style="width: ${roundedWeight}%"></div>
                                    </div>
                                    <span class="value-mini">${roundedWeight}%</span>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    `;
                }).join('')}
            `;
        }

        // ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–é–¢æ•°ï¼ˆStreamlitåŒç­‰: åˆæœŸ2ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å›ºå®šã§è¡¨ç¤ºï¼‰
        function initializeChat() {
            // æ¯”è¼ƒã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æ›´æ–°
            try { updateComparisonView(); } catch (e) {}
            showLoading(true);
            const payload = {
                decision: initialDecisionData ? initialDecisionData.decision : 'æœªå®š',
                weights: initialDecisionData ? initialDecisionData.weights : {}
            };
            fetch('/setup_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                conversationCount = 0;
                document.getElementById('messageCount').textContent = '0';
                if (data.success && Array.isArray(data.messages)) {
                    data.messages.forEach(m => addMessage(m.content, false));
                } else {
                    addMessage('åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', false);
                }
            })
            .catch(err => {
                console.error('setup_chat ã‚¨ãƒ©ãƒ¼:', err);
                showLoading(false);
                addMessage('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', false);
            });
        }

        // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const messageCount = document.getElementById('messageCount');
        const finishChat = document.getElementById('finishChat');

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message' : 'ai-message';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = renderMarkdown(content);

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            chatInput.value = '';

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹
            showLoading(true);

            fetch('/ai_chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    decision: initialDecisionData.decision,
                    conversation_count: conversationCount
                })
            })
            .then(response => response.json())
            .then(data => {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
                showLoading(false);

                setTimeout(() => {
                    const aiMsg = data.message || data.response || '...';
                    addMessage(aiMsg, false);
                    conversationCount++;
                    messageCount.textContent = conversationCount;

                    if (conversationCount >= 4) {
                        finishChat.style.display = 'block';
                        // å…¥åŠ›ã¯ç¶™ç¶šå¯èƒ½ï¼ˆæœ€ä½4å›ã®é”æˆã®ã¿ï¼‰
                    }
                }, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                showLoading(false);
                addMessage('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', false);
            });
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡é–¢æ•°
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const chatInputContainer = document.querySelector('.chat-input-container');

            if (show) {
                loadingIndicator.style.display = 'flex';
                chatInputContainer.classList.add('loading');
                sendButton.disabled = true;
                chatInput.disabled = true;
            } else {
                loadingIndicator.style.display = 'none';
                chatInputContainer.classList.remove('loading');
                sendButton.disabled = false;
                chatInput.disabled = false;
            }
        }

        if (sendButton) {
            sendButton.addEventListener('click', sendMessage);
        }

        if (chatInput) {
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // ä¿¡é ¼åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        const confidenceSlider = document.getElementById('confidence');
        const confidenceValue = document.getElementById('confidence-value');

        if (confidenceSlider) {
            confidenceSlider.addEventListener('input', function() {
                confidenceValue.textContent = this.value;
            });
        }

        // æœ€çµ‚æ±ºå®šãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('finalDecisionForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const total = parseInt(document.getElementById('final-total-weight').textContent);
            if (total !== 100) {
                alert('é‡è¦åº¦ã®åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®åˆè¨ˆ: ' + total + '%');
                return;
            }

            const formData = new FormData(this);
            const data = {
                trial: parseInt('{{ trial }}'),
                final_decision: formData.get('final_decision'),
                final_weights: {},
                change_reasoning: formData.get('change_reasoning') || '',
                confidence: parseInt(formData.get('confidence')),
                initial_decision: initialDecisionData,
                timestamp: new Date().toISOString()
            };

            // æœ€çµ‚é‡ã¿ã‚’å–å¾—
            const finalCriteria = {{ info.criteria | tojson }};
            finalCriteria.forEach(criterion => {
                data.final_weights[criterion] = parseInt(formData.get('final_' + criterion));
            });

            console.log('æœ€çµ‚æ±ºå®šãƒ‡ãƒ¼ã‚¿é€ä¿¡:', data);

            fetch('/save_final_decision', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('æœ€çµ‚æ±ºå®šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                return response.json();
            })
            .then(result => {
                console.log('æœ€çµ‚æ±ºå®šã‚µãƒ¼ãƒãƒ¼å¿œç­”:', result);
                if (result.success && result.next) {
                    console.log('æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸é·ç§»:', result.next);
                    window.location.href = result.next;
                } else if (result.error) {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                } else {
                    alert('äºˆæœŸã—ãªã„å¿œç­”å½¢å¼ã§ã™ã€‚');
                    console.error('Unexpected response:', result);
                }
            })
            .catch(error => {
                console.error('æœ€çµ‚æ±ºå®šé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            });
        });

        // åˆæœŸæ±ºå®šè¡¨ç¤ºæ›´æ–°ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ç”¨ï¼‰
        function updateInitialDecisionSummary() {
            if (initialDecisionData) {
                const summary = document.getElementById('initialDecisionSummary');
                if (summary) {
                    const decisionClass = initialDecisionData.decision === 'ä¸€æ¬¡é€šé' ? 'pass' : 'fail';
                    summary.innerHTML = `
                        <div class="decision-badge ${decisionClass}">
                            ${initialDecisionData.decision}
                        </div>
                        <div class="weight-summary">
                            ${Object.entries(initialDecisionData.weights).map(([criterion, weight]) => `
                                <span class="weight-item">${displayName(criterion)}: ${weight}%</span>
                            `).join(', ')}
                        </div>
                    `;
                }
            }
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´æ™‚ã®å‡¦ç†
        document.addEventListener('phaseChange', function(e) {
            if (e.detail.phase === 3) {
                updateInitialDecisionSummary();
            }
        });
    });
</script>
{% endblock %}
<!--  --- Chat helpers duplicate (disabled) ---
    function escapeHtml(str) {
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
-->

function renderMarkdown(src) { if (!src) return ''; // Preserve code blocks
first const blocks = []; let text = src.replace(/```([\s\S]*?)```/g, (_, code)
=> { blocks.push(`
<pre><code>${escapeHtml(code.trim())}</code></pre>
`); return `@@BLOCK${blocks.length - 1}@@`; }); text = escapeHtml(text); //
Inline code text = text.replace(/`([^`]+)`/g, '<code>$1</code>'); // Links
[text](url) text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^)\s]+)\)/g, '<a
    href="$2"
    target="_blank"
    rel="noopener noreferrer"
    >$1</a
>'); // Bold/Italic (process bold first) text = text.replace(/\*\*([^*]+)\*\*/g,
'<strong>$1</strong>'); text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>'); //
Headings (at line starts) text = text.replace(/^###\s+(.+)$/gm, '
<h3>$1</h3>
') .replace(/^##\s+(.+)$/gm, '
<h2>$1</h2>
') .replace(/^#\s+(.+)$/gm, '
<h1>$1</h1>
'); // Lists text = text.replace(/(^|\n)(?:\s*[-\*]\s+.+(?:\n\s*[-\*]\s+.+)*)/g,
(m) => { const items = m.trim().split(/\n/).map(line =>
line.replace(/^\s*[-\*]\s+/, '')).map(li => `
<li>${li}</li>
`).join(''); return `\n
<ul>
    ${items}
</ul>
`; }); text = text.replace(/(^|\n)(?:\s*\d+\.\s+.+(?:\n\s*\d+\.\s+.+)*)/g, (m)
=> { const items = m.trim().split(/\n/).map(line => line.replace(/^\s*\d+\.\s+/,
'')).map(li => `
<li>${li}</li>
`).join(''); return `\n
<ol>
    ${items}
</ol>
`; }); // Paragraphs and line breaks const parts = text.split(/\n\n+/).map(p =>
`
<p>${p.replace(/\n/g, '<br />')}</p>
`); let html = parts.join(''); // Restore code blocks html =
html.replace(/@@BLOCK(\d+)@@/g, (_, i) => blocks[Number(i)] || ''); return html;
}
