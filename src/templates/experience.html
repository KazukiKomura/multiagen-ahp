{% extends "base.html" %}

{% block title %}ä½“é¨“ãƒ•ã‚§ãƒ¼ã‚º - æ„æ€æ±ºå®šå®Ÿé¨“ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="experience-section">
    <!-- ä¸ŠåŠåˆ†ï¼šå¸¸æ™‚è¡¨ç¤ºã•ã‚Œã‚‹æ„æ€æ±ºå®šæƒ…å ± -->
    <div class="decision-info-panel">
        <div class="info-header">
            <h2>{{ info.title }} (ãƒˆãƒ©ã‚¤ã‚¢ãƒ« {{ trial }})</h2>
            <p>{{ info.description }}</p>
        </div>
        
        <div class="candidate-profile">
            <div class="profile-header">
                <h3>å¿œå‹Ÿè€… {{ info.student.id }} ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
                <div class="basic-info">
                    <span class="info-tag">{{ info.student.major }}</span>
                    <span class="info-tag">{{ info.student.region }}</span>
                    <span class="info-tag">{{ info.student.institution_rank }}æ©Ÿé–¢</span>
                </div>
            </div>

            <!-- 5ã¤ã®è©•ä¾¡é …ç›®ã‚’æ˜ç¢ºã«è¡¨ç¤º -->
            <div class="evaluation-categories">
                <!-- 1. å­¦æ¥­æˆç¸¾ -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸ“š å­¦æ¥­æˆç¸¾</h4>
                    </div>
                    <div class="category-details">
                        <div class="score-large">GPA {{ info.student.gpa }}/4.0</div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: {{ (info.student.gpa / 4.0 * 100) | round | int }}%"></div>
                        </div>
                        <div class="category-description">ç›´è¿‘ã®å­¦ä½ã§ã®æˆç¸¾å¹³å‡</div>
                    </div>
                </div>

                <!-- 2. è©¦é¨“ã‚¹ã‚³ã‚¢ -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸ“ è©¦é¨“ã‚¹ã‚³ã‚¢</h4>
                    </div>
                    <div class="category-details">
                        <div class="score-breakdown">
                            <div class="subscore">å®šé‡: <strong>{{ info.student.gre_quant }}</strong>/170</div>
                            <div class="subscore">è¨€èª: <strong>{{ info.student.gre_verbal }}</strong>/170</div>
                            <div class="subscore">ä½œæ–‡: <strong>{{ info.student.gre_writing }}</strong>/6.0</div>
                        </div>
                        <div class="category-description">GREç·åˆã‚¹ã‚³ã‚¢: {{ info.student.gre_quant + info.student.gre_verbal }}/340</div>
                    </div>
                </div>

                <!-- 3. ç ”ç©¶èƒ½åŠ› -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸ”¬ ç ”ç©¶èƒ½åŠ›</h4>
                    </div>
                    <div class="category-details">
                        <div class="score-breakdown">
                            <div class="subscore">å¿—æœ›å‹•æ©Ÿæ›¸: <strong>{{ info.student.sop_score }}</strong>/5.0</div>
                            <div class="subscore">å¤šæ§˜æ€§å£°æ˜: <strong>{{ info.student.diversity_score }}</strong>/5.0</div>
                        </div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: {{ (info.student.sop_score / 5 * 100) | round | int }}%"></div>
                        </div>
                        <div class="category-description">ç ”ç©¶ã¸ã®æ„æ¬²ãƒ»èƒ½åŠ›è©•ä¾¡</div>
                    </div>
                </div>

                <!-- 4. æ¨è–¦çŠ¶ -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸ“„ æ¨è–¦çŠ¶</h4>
                    </div>
                    <div class="category-details">
                        <div class="rec-letters-display">
                            {% for letter in info.student.rec_letters %}
                            <div class="letter-item {{ 'excellent' if 'å„ªç§€' in letter else ('average' if 'æ™®é€š' in letter else 'weak') }}">
                                {{ letter }}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="category-description">3é€šã®æ¨è–¦çŠ¶è©•ä¾¡</div>
                    </div>
                </div>

                <!-- 5. å¤šæ§˜æ€§ -->
                <div class="category-card">
                    <div class="category-header">
                        <h4>ğŸŒ å¤šæ§˜æ€§</h4>
                    </div>
                    <div class="category-details">
                        <div class="score-large">{{ info.student.diversity_score }}/5.0</div>
                        <div class="diversity-info">
                            <div class="diversity-item">å°‚æ”»: <strong>{{ info.student.major }}</strong></div>
                            <div class="diversity-item">å‡ºèº«: <strong>{{ info.student.region }}</strong></div>
                            <div class="diversity-item">æ©Ÿé–¢: <strong>{{ info.student.institution_rank }}ãƒ©ãƒ³ã‚¯</strong></div>
                        </div>
                        <div class="category-description">èƒŒæ™¯ãƒ»çµŒé¨“ã®å¤šæ§˜æ€§è©•ä¾¡</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸‹åŠåˆ†ï¼šæ“ä½œãƒ•ã‚§ãƒ¼ã‚ºåˆ‡ã‚Šæ›¿ãˆã‚¨ãƒªã‚¢ -->
    <div class="operation-panel">
        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º -->
        <div class="progress-bar">
            <div class="step active" data-step="0">
                <span class="step-number">1</span>
                <span class="step-label">ã‚ãªãŸã®æ„è¦‹</span>
            </div>
            <div class="step" data-step="1">
                <span class="step-number">2</span>
                <span class="step-label">ä»–ã®æ„è¦‹ç¢ºèª</span>
            </div>
            <div class="step" data-step="2">
                <span class="step-number">3</span>
                <span class="step-label">AIãƒãƒ£ãƒƒãƒˆ</span>
            </div>
            <div class="step" data-step="3">
                <span class="step-number">4</span>
                <span class="step-label">æœ€çµ‚æ±ºå®š</span>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º1: è‡ªåˆ†ã®æ„è¦‹è¡¨æ˜ -->
        <div class="phase-content active" data-phase="0">
            <h3>ã‚ãªãŸã®æ„è¦‹ã‚’ãŠèã‹ã›ãã ã•ã„</h3>
            <form id="initialDecisionForm" method="post" action="javascript:void(0);">
                <div class="decision-choice">
                    <h4>å…¥å­¦åˆ¤å®šã‚’ãŠé¸ã³ãã ã•ã„</h4>
                    <div class="radio-group simple-options">
                        <label>
                            <input type="radio" name="decision" value="åˆæ ¼" required>
                            <span class="radio-custom"></span>
                            åˆæ ¼
                        </label>
                        <label>
                            <input type="radio" name="decision" value="ä¸åˆæ ¼" required>
                            <span class="radio-custom"></span>
                            ä¸åˆæ ¼
                        </label>
                    </div>
                </div>

                <div class="weights-section">
                    <h4>å„åŸºæº–ã®é‡è¦åº¦ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆåˆè¨ˆ100%ï¼‰</h4>
                    <div class="weights-container">
                        {% for criterion in info.criteria %}
                        <div class="weight-item">
                            <label for="{{ criterion }}">{{ criterion }}</label>
                            <div class="weight-controls">
                                <input type="range" 
                                       id="{{ criterion }}" 
                                       name="{{ criterion }}" 
                                       min="0" 
                                       max="100" 
                                       value="20" 
                                       step="10"
                                       class="weight-slider">
                                <span class="weight-value" id="{{ criterion }}-value">20</span>%
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="total-weight">
                        åˆè¨ˆ: <span id="total-weight">100</span>%
                    </div>
                </div>

                <div class="reasoning-section">
                    <h4>åˆ¤æ–­ç†ç”±ï¼ˆä»»æ„ï¼‰</h4>
                    <textarea name="reasoning" rows="3" placeholder="åˆ¤æ–­ç†ç”±ã‚’ã”è¨˜å…¥ãã ã•ã„"></textarea>
                </div>

                <button type="button" class="btn btn-primary" id="confirmDecisionBtn">æ„è¦‹ã‚’ç¢ºå®šã—ã¦æ¬¡ã¸</button>
            </form>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º2: ä»–ã®æ„è¦‹ç¢ºèª -->
        <div class="phase-content" data-phase="1">
            <h3>ä»–ã®å‚åŠ è€…ã®æ„è¦‹</h3>
            <div class="opinions-comparison">
                <div class="my-opinion">
                    <h4>ã‚ãªãŸã®æ„è¦‹</h4>
                    <div class="opinion-summary" id="myOpinionSummary">
                        <!-- JavaScript ã§å‹•çš„ã«è¡¨ç¤º -->
                    </div>
                </div>
                
                <div class="others-opinions">
                    <h4>ä»–ã®å‚åŠ è€…ã®æ„è¦‹</h4>
                    <div class="opinions-grid" id="othersOpinions">
                        <!-- JavaScript ã§å‹•çš„ã«è¡¨ç¤º -->
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="nextPhase()">AIãƒãƒ£ãƒƒãƒˆã¸é€²ã‚€</button>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º3: AIãƒãƒ£ãƒƒãƒˆ -->
        <div class="phase-content" data-phase="2">
            <h3>AIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã¨ã®å¯¾è©±</h3>
            <div class="split-view">
                <div class="opinions-sidebar">
                    <h4>æ„è¦‹ã®æ¯”è¼ƒ</h4>
                    <div id="comparisonView">
                        <!-- JavaScript ã§å‹•çš„ã«è¡¨ç¤º -->
                    </div>
                </div>
                
                <div class="chat-area">
                    <div class="chat-messages" id="chatMessages">
                        <!-- AIåˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
                    </div>
                    
                    <!-- Loading indicator -->
                    <div class="loading-indicator" id="loadingIndicator" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">AIãŒå›ç­”ã‚’è€ƒãˆã¦ã„ã¾ã™...</div>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." maxlength="500">
                        <button id="sendButton" class="btn btn-primary">é€ä¿¡</button>
                    </div>
                    
                    <div class="chat-info">
                        <p>ä¼šè©±å›æ•°: <span id="messageCount">0</span>/5</p>
                        <button class="btn btn-secondary" id="finishChat" style="display: none;" onclick="nextPhase()">å¯¾è©±ã‚’çµ‚äº†ã—ã¦æœ€çµ‚æ±ºå®šã¸</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º4: æœ€çµ‚æ±ºå®š -->
        <div class="phase-content" data-phase="3">
            <h3>æœ€çµ‚æ±ºå®š</h3>
            <div class="final-decision-area">
                <div class="decision-comparison">
                    <div class="initial-decision">
                        <h4>åˆå›ã®åˆ¤æ–­</h4>
                        <div id="initialDecisionSummary">
                            <!-- JavaScript ã§å‹•çš„ã«è¡¨ç¤º -->
                        </div>
                    </div>
                </div>

                <form id="finalDecisionForm" method="post" action="javascript:void(0);">
                    <div class="final-choice">
                        <h4>æœ€çµ‚åˆ¤å®š</h4>
                        <div class="radio-group simple-options">
                            <label>
                                <input type="radio" name="final_decision" value="åˆæ ¼" required>
                                <span class="radio-custom"></span>
                                åˆæ ¼
                            </label>
                            <label>
                                <input type="radio" name="final_decision" value="ä¸åˆæ ¼" required>
                                <span class="radio-custom"></span>
                                ä¸åˆæ ¼
                            </label>
                        </div>
                    </div>

                    <div class="final-weights">
                        <h4>æœ€çµ‚é‡è¦åº¦è¨­å®š</h4>
                        <div class="weights-container">
                            {% for criterion in info.criteria %}
                            <div class="weight-item">
                                <label for="final_{{ criterion }}">{{ criterion }}</label>
                                <div class="weight-controls">
                                    <input type="range" 
                                           id="final_{{ criterion }}" 
                                           name="final_{{ criterion }}" 
                                           min="0" 
                                           max="100" 
                                           value="20" 
                                           step="10"
                                           class="weight-slider final-slider">
                                    <span class="weight-value" id="final_{{ criterion }}-value">20</span>%
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="total-weight">
                            åˆè¨ˆ: <span id="final-total-weight">100</span>%
                        </div>
                    </div>

                    <div class="change-reasoning">
                        <h4>å¤‰æ›´ç†ç”±ï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰</h4>
                        <textarea name="change_reasoning" rows="3" 
                                  placeholder="åˆ¤æ–­ã‚„é‡è¦åº¦ã‚’å¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ãã®ç†ç”±ã‚’ãŠèã‹ã›ãã ã•ã„"></textarea>
                    </div>

                    <div class="confidence-rating">
                        <h4>æœ€çµ‚åˆ¤æ–­ã¸ã®ä¿¡é ¼åº¦</h4>
                        <div class="scale-input">
                            <input type="range" id="confidence" name="confidence" min="1" max="7" value="4" class="slider">
                            <div class="scale-labels">
                                <span>å…¨ãä¿¡é ¼ã—ã¦ã„ãªã„</span>
                                <span class="scale-value" id="confidence-value">4</span>
                                <span>å®Œå…¨ã«ä¿¡é ¼ã—ã¦ã„ã‚‹</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">æœ€çµ‚æ±ºå®šã‚’ç¢ºå®šã™ã‚‹</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Loading indicator styles */
.loading-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin: 10px 0;
    border: 1px solid #e9ecef;
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #e9ecef;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

.loading-text {
    color: #6c757d;
    font-size: 14px;
    font-style: italic;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Chat input disabled state */
.chat-input-container.loading input {
    opacity: 0.6;
    pointer-events: none;
}

.chat-input-container.loading button {
    opacity: 0.6;
    pointer-events: none;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ“ DOMContentLoaded event fired');
    
    // ãƒ‡ãƒãƒƒã‚°: å…¨ä½“çš„ãªè¦ç´ ç¢ºèª
    const allForms = document.querySelectorAll('form');
    console.log('âœ“ ãƒšãƒ¼ã‚¸å†…ã®ãƒ•ã‚©ãƒ¼ãƒ æ•°:', allForms.length);
    
    const allButtons = document.querySelectorAll('button');
    console.log('âœ“ ãƒšãƒ¼ã‚¸å†…ã®ãƒœã‚¿ãƒ³æ•°:', allButtons.length);
    
    allButtons.forEach((btn, index) => {
        console.log(`  ãƒœã‚¿ãƒ³${index}: id="${btn.id}", type="${btn.type}", text="${btn.textContent.trim()}"`);
    });
    
    let currentPhase = 0;
    let initialDecisionData = null;
    let botOpinions = [];
    let conversationCount = 0;
    
    // é‡è¦åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼é–¢æ•°
    function setupWeightSliders(containerSelector) {
        const container = document.querySelector(containerSelector);
        const weightSliders = container.querySelectorAll('.weight-slider');
        const totalWeightDisplay = container.querySelector('.total-weight span');
        
        function updateWeights() {
            let total = 0;
            weightSliders.forEach(slider => {
                const value = parseInt(slider.value);
                total += value;
                document.getElementById(slider.id + '-value').textContent = value;
            });
            
            totalWeightDisplay.textContent = total;
            totalWeightDisplay.className = total === 100 ? 'correct' : 'incorrect';
        }

        weightSliders.forEach(slider => {
            slider.addEventListener('input', updateWeights);
        });
        
        updateWeights();
        return { weightSliders, updateWeights };
    }

    // åˆæœŸé‡è¦åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®š
    const initialWeights = setupWeightSliders('[data-phase="0"]');
    
    // ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡ã‚Šæ›¿ãˆ
    function showPhase(phaseIndex) {
        document.querySelectorAll('.phase-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.step').forEach(step => {
            step.classList.remove('active');
        });
        
        document.querySelector(`[data-phase="${phaseIndex}"]`).classList.add('active');
        document.querySelector(`[data-step="${phaseIndex}"]`).classList.add('active');
        
        currentPhase = phaseIndex;
        
        if (phaseIndex === 2) {
            // AIãƒãƒ£ãƒƒãƒˆãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã«æ‰‹ç¶šãèª¬æ˜ã‚’å–å¾—
            initializeChat();
        } else if (phaseIndex === 3) {
            // æœ€çµ‚æ±ºå®šãƒ•ã‚§ãƒ¼ã‚ºã®é‡è¦åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®š
            setTimeout(() => {
                const finalWeights = setupWeightSliders('[data-phase="3"]');
                // åˆæœŸå€¤ã‚’è¨­å®š
                if (initialDecisionData) {
                    Object.entries(initialDecisionData.weights).forEach(([criterion, weight]) => {
                        const slider = document.getElementById(`final_${criterion}`);
                        if (slider) {
                            slider.value = weight;
                        }
                    });
                    finalWeights.updateWeights();
                }
            }, 100);
        }
    }

    window.nextPhase = function() {
        if (currentPhase < 3) {
            showPhase(currentPhase + 1);
        }
    };

    // ãƒ•ã‚§ãƒ¼ã‚º1: åˆæœŸæ±ºå®šãƒœã‚¿ãƒ³
    const confirmBtn = document.getElementById('confirmDecisionBtn');
    const initialForm = document.getElementById('initialDecisionForm');
    
    if (!confirmBtn || !initialForm) {
        console.error('confirmDecisionBtn ã¾ãŸã¯ initialDecisionForm ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    console.log('âœ“ æ„è¦‹ç¢ºå®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
    
    confirmBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('âœ“ æ„è¦‹ç¢ºå®šãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
        console.log('  ã‚¤ãƒ™ãƒ³ãƒˆ:', e);
        console.log('  ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ :', initialForm);
        
        const total = parseInt(document.getElementById('total-weight').textContent);
        if (total !== 100) {
            alert('é‡è¦åº¦ã®åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®åˆè¨ˆ: ' + total + '%');
            return;
        }
        
        const formData = new FormData(initialForm);
        
        console.log('ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å†…å®¹ç¢ºèª:');
        for (let [key, value] of formData.entries()) {
            console.log('  ' + key + ': ' + value);
        }
        
        const data = {
            trial: parseInt('{{ trial }}'),
            decision: formData.get('decision'),
            weights: {},
            reasoning: formData.get('reasoning') || '',
            timestamp: new Date().toISOString()
        };
        
        // åŸºæº–ã®é‡ã¿ã‚’å–å¾—
        const criteria = {{ info.criteria | tojson }};
        criteria.forEach(criterion => {
            const criterionValue = parseInt(formData.get(criterion));
            data.weights[criterion] = isNaN(criterionValue) ? 0 : criterionValue;
            console.log('é‡ã¿ - ' + criterion + ':', data.weights[criterion]);
        });

        initialDecisionData = data;

        console.log('æ„æ€æ±ºå®šãƒ‡ãƒ¼ã‚¿é€ä¿¡:', data);
        
        fetch('/save_decision', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
            return response.json();
        })
        .then(result => {
            console.log('ã‚µãƒ¼ãƒãƒ¼å¿œç­”:', result);
            if (result.success && result.bot_opinions) {
                botOpinions = result.bot_opinions;
                showPhase1Content();
                nextPhase();
            } else if (result.error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
            } else {
                alert('äºˆæœŸã—ãªã„å¿œç­”å½¢å¼ã§ã™ã€‚');
                console.error('Unexpected response:', result);
            }
        })
        .catch(error => {
            console.error('Fetch ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        });
    });

    // ãƒ•ã‚§ãƒ¼ã‚º2è¡¨ç¤ºå†…å®¹æ›´æ–°
    function showPhase1Content() {
        // è‡ªåˆ†ã®æ„è¦‹è¡¨ç¤º
        const myOpinionSummary = document.getElementById('myOpinionSummary');
        myOpinionSummary.innerHTML = `
            <div class="decision-badge ${initialDecisionData.decision === 'è³›æˆ' ? 'agree' : 'disagree'}">
                ${initialDecisionData.decision}
            </div>
            <div class="weight-bars">
                ${Object.entries(initialDecisionData.weights).map(([criterion, weight]) => `
                    <div class="weight-bar-small">
                        <span class="criterion">${criterion}:</span>
                        <div class="bar">
                            <div class="fill" style="width: ${weight}%"></div>
                        </div>
                        <span class="value">${weight}%</span>
                    </div>
                `).join('')}
            </div>
        `;

        // ä»–ã®å‚åŠ è€…ã®æ„è¦‹è¡¨ç¤º
        const othersOpinions = document.getElementById('othersOpinions');
        othersOpinions.innerHTML = botOpinions.map(opinion => `
            <div class="opinion-card">
                <h5>å‚åŠ è€… ${opinion.bot_id + 1}</h5>
                <div class="decision-badge ${opinion.decision === 'è³›æˆ' ? 'agree' : 'disagree'}">
                    ${opinion.decision}
                </div>
                <div class="weight-bars">
                    ${Object.entries(opinion.weights).map(([criterion, weight]) => `
                        <div class="weight-bar-small">
                            <span class="criterion">${criterion}:</span>
                            <div class="bar">
                                <div class="fill" style="width: ${weight}%"></div>
                            </div>
                            <span class="value">${weight}%</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');

        // ãƒ•ã‚§ãƒ¼ã‚º3ã®æ¯”è¼ƒè¡¨ç¤ºã‚‚æ›´æ–°
        updateComparisonView();
    }

    function updateComparisonView() {
        const comparisonView = document.getElementById('comparisonView');
        comparisonView.innerHTML = `
            <div class="comparison-item">
                <h5>ã‚ãªãŸã®æ„è¦‹</h5>
                <div class="decision-badge ${initialDecisionData.decision === 'è³›æˆ' ? 'agree' : 'disagree'}">
                    ${initialDecisionData.decision}
                </div>
            </div>
            ${botOpinions.map(opinion => `
                <div class="comparison-item">
                    <h5>å‚åŠ è€… ${opinion.bot_id + 1}</h5>
                    <div class="decision-badge ${opinion.decision === 'è³›æˆ' ? 'agree' : 'disagree'}">
                        ${opinion.decision}
                    </div>
                </div>
            `).join('')}
        `;
    }

    // ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–é–¢æ•°
    function initializeChat() {
        // ã¾ãšã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        showLoading(true);
        
        fetch('/reset_chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(resetData => {
            if (resetData.success) {
                // ãƒªã‚»ãƒƒãƒˆæˆåŠŸå¾Œã€æ‰‹ç¶šãèª¬æ˜ã‚’å–å¾—ï¼ˆturn 1ï¼‰
                return fetch('/ai_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'æ‰‹ç¶šãã¨ãƒ«ãƒ¼ãƒ«ã®èª¬æ˜ã‚’ãŠé¡˜ã„ã—ã¾ã™',
                        decision: initialDecisionData ? initialDecisionData.decision : 'æœªå®š',
                        conversation_count: 0
                    })
                });
            } else {
                throw new Error('ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.message) {
                // 1ã¤ç›®ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ‰‹ç¶šãèª¬æ˜ï¼‰ã‚’è¡¨ç¤º
                const rulesMsg = data.message;
                addMessage(rulesMsg, false);
                
                // ã™ãã«2å›ç›®ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆæ·±æ˜ã‚Šè³ªå•ï¼‰ã‚’é€ä¿¡
                return fetch('/ai_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'ã‚ã‹ã‚Šã¾ã—ãŸ',
                        decision: initialDecisionData ? initialDecisionData.decision : 'æœªå®š',
                        conversation_count: 1
                    })
                });
            } else {
                throw new Error('æ‰‹ç¶šãèª¬æ˜ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
            }
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.success && data.message) {
                // 2ã¤ç›®ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ·±æ˜ã‚Šè³ªå•ï¼‰ã‚’è¡¨ç¤º
                const prefsMsg = data.message;
                addMessage(prefsMsg, false);
            } else {
                addMessage('æ·±æ˜ã‚Šè³ªå•ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', false);
            }
        })
        .catch(error => {
            console.error('åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            showLoading(false);
            addMessage('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', false);
        });
    }

    // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const messageCount = document.getElementById('messageCount');
    const finishChat = document.getElementById('finishChat');

    function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = isUser ? 'user-message' : 'ai-message';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;
        
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        addMessage(message, true);
        chatInput.value = '';
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹
        showLoading(true);

        fetch('/ai_chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                decision: initialDecisionData.decision,
                conversation_count: conversationCount
            })
        })
        .then(response => response.json())
        .then(data => {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
            showLoading(false);
            
            setTimeout(() => {
                const aiMsg = data.message || data.response || '...';
                addMessage(aiMsg, false);
                conversationCount++;
                messageCount.textContent = conversationCount;
                
                if (conversationCount >= 5) {
                    chatInput.disabled = true;
                    sendButton.disabled = true;
                    finishChat.style.display = 'block';
                    addMessage('ååˆ†ãªå¯¾è©±ãŒã§ãã¾ã—ãŸã€‚æœ€çµ‚æ±ºå®šã«é€²ã‚“ã§ãã ã•ã„ã€‚', false);
                }
            }, 500);
        })
        .catch(error => {
            console.error('Error:', error);
            showLoading(false);
            addMessage('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', false);
        });
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡é–¢æ•°
    function showLoading(show) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const chatInputContainer = document.querySelector('.chat-input-container');
        
        if (show) {
            loadingIndicator.style.display = 'flex';
            chatInputContainer.classList.add('loading');
            sendButton.disabled = true;
            chatInput.disabled = true;
        } else {
            loadingIndicator.style.display = 'none';
            chatInputContainer.classList.remove('loading');
            sendButton.disabled = false;
            chatInput.disabled = false;
        }
    }

    if (sendButton) {
        sendButton.addEventListener('click', sendMessage);
    }
    
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // ä¿¡é ¼åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    const confidenceSlider = document.getElementById('confidence');
    const confidenceValue = document.getElementById('confidence-value');
    
    if (confidenceSlider) {
        confidenceSlider.addEventListener('input', function() {
            confidenceValue.textContent = this.value;
        });
    }

    // æœ€çµ‚æ±ºå®šãƒ•ã‚©ãƒ¼ãƒ 
    document.getElementById('finalDecisionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const total = parseInt(document.getElementById('final-total-weight').textContent);
        if (total !== 100) {
            alert('é‡è¦åº¦ã®åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®åˆè¨ˆ: ' + total + '%');
            return;
        }
        
        const formData = new FormData(this);
        const data = {
            trial: parseInt('{{ trial }}'),
            final_decision: formData.get('final_decision'),
            final_weights: {},
            change_reasoning: formData.get('change_reasoning') || '',
            confidence: parseInt(formData.get('confidence')),
            initial_decision: initialDecisionData,
            timestamp: new Date().toISOString()
        };
        
        // æœ€çµ‚é‡ã¿ã‚’å–å¾—
        const finalCriteria = {{ info.criteria | tojson }};
        finalCriteria.forEach(criterion => {
            data.final_weights[criterion] = parseInt(formData.get('final_' + criterion));
        });

        console.log('æœ€çµ‚æ±ºå®šãƒ‡ãƒ¼ã‚¿é€ä¿¡:', data);
        
        fetch('/save_final_decision', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('æœ€çµ‚æ±ºå®šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
            return response.json();
        })
        .then(result => {
            console.log('æœ€çµ‚æ±ºå®šã‚µãƒ¼ãƒãƒ¼å¿œç­”:', result);
            if (result.success && result.next) {
                console.log('æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸é·ç§»:', result.next);
                window.location.href = result.next;
            } else if (result.error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
            } else {
                alert('äºˆæœŸã—ãªã„å¿œç­”å½¢å¼ã§ã™ã€‚');
                console.error('Unexpected response:', result);
            }
        })
        .catch(error => {
            console.error('æœ€çµ‚æ±ºå®šé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        });
    });

    // åˆæœŸæ±ºå®šè¡¨ç¤ºæ›´æ–°ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ç”¨ï¼‰
    function updateInitialDecisionSummary() {
        if (initialDecisionData) {
            const summary = document.getElementById('initialDecisionSummary');
            if (summary) {
                summary.innerHTML = `
                    <div class="decision-badge ${initialDecisionData.decision === 'è³›æˆ' ? 'agree' : 'disagree'}">
                        ${initialDecisionData.decision}
                    </div>
                    <div class="weight-summary">
                        ${Object.entries(initialDecisionData.weights).map(([criterion, weight]) => `
                            <span class="weight-item">${criterion}: ${weight}%</span>
                        `).join(', ')}
                    </div>
                `;
            }
        }
    }

    // ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´æ™‚ã®å‡¦ç†
    document.addEventListener('phaseChange', function(e) {
        if (e.detail.phase === 3) {
            updateInitialDecisionSummary();
        }
    });
});
</script>
{% endblock %}
