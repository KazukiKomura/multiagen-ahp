# 論理エンジン統合 - セットアップ完了ガイド

## 📋 実装内容の概要

既存のAIチャット機能に「論理エンジン」を統合し、議論の構造を分析してより鋭い質問ができるAIファシリテーターに改良しました。

## 🚀 実装されたファイル

### 1. **新規作成ファイル**
- `src/utils/argumentation_engine.py` - 論理エンジン本体
- `src/templates/chat_test.html` - テスト用スタンドアロンHTML

### 2. **修正ファイル**
- `src/routes/ai_chat.py` - 論理エンジン統合
- `src/routes/main.py` - テストページルート追加
- `prompts/system_prompt.txt` - LLM指示の更新

## 🔧 動作確認手順

### **手順1: サーバー起動**
```bash
cd /Users/kazukikomura/Developer/research/multiagentahp
python run.py
```

### **手順2: テストページにアクセス**
ブラウザで以下のURLを開く：
```
http://localhost:5000/chat_test
```

### **手順3: 論理エンジンのテスト**

1. **基本設定**
   - ユーザー判断: 「合格」を選択
   - 学業成績重視度: 40%
   - その他項目: 各15%ずつ（合計100%になるよう調整）

2. **チャット初期化**
   - 「チャット初期化」ボタンを押す
   - 初期メッセージが2つ表示される

3. **論理エンジンテスト**
   - 「学業成績を重視する理由は何ですか？」のような質問に回答
   - AI応答で、論理エンジンが分析した「価値観の対立」に基づく質問が返ってくる

4. **デバッグ情報確認**
   - 「デバッグ表示切替」ボタンでエンジン分析結果を確認
   - `argumentation_analysis`セクションで論点分析結果が表示される

## 🧠 論理エンジンの仕組み

### **分析プロセス**
```python
# 1. 主張抽出
arguments = extract_atomic_arguments(context)
# ユーザー: 「学業成績40%重視で合格」
# 参加者1: 「研究能力30%重視で不合格」

# 2. 攻撃関係特定
attacks = determine_attacks(arguments)
# (arg_p1, arg_user) - 参加者1がユーザーを攻撃

# 3. 議論要約
debate_summary = summarize_debate(arguments, attacks)
# 「学業成績重視 vs 研究能力重視の価値観対立」
```

### **生成される分析結果例**
```json
{
  "key_conflict_point": "学業成績重視 vs 研究能力重視の価値観対立",
  "user_claim_summary": "ユーザーは学業成績(40%)を最重視して合格と判断",
  "opponent_claim_summary": "参加者1は研究能力(30%)を最重視して不合格と判断",
  "suggested_question": "なぜ学業成績を研究能力より重視するのか、具体的な根拠について"
}
```

## 🐛 デバッグオプション

### **詳細ログの有効化**
```bash
export DEBUG_LLM_CONTEXT=1
python run.py
```

これにより、コンソールに以下が出力されます：
- 論理エンジン分析結果
- LLMに渡されるコンテキスト全体
- 抽出された主張数・攻撃関係数

## ⚡ 期待される改善効果

### **Before (従来)**
- 表面的な質問: 「どの項目を重視しますか？」
- 一般的な確認: 「理由を教えてください」

### **After (論理エンジン統合後)**
- 価値観対立に基づく鋭い質問: 「なぜ学業成績を研究能力より重視するのですか？」
- 議論構造を踏まえた深掘り: 「参加者は研究能力を重視していますが、どう反論しますか？」

## 🔍 実際の実験への適用

この論理エンジンは、実際の実験セッション（`/experience` → AIチャット）でも自動的に動作します。

1. 参加者が意思決定と重み付けを入力
2. 他参加者の意見と比較
3. **AIチャット開始時に論理エンジンが自動分析**
4. 価値観の対立点を特定した上で対話開始

## 🚨 トラブルシューティング

### **エラー「論理エンジン分析エラー」**
- 参加者データが不足している可能性
- デバッグモードで詳細確認

### **「分析データが不足しています」**
- ユーザーの判断・重み付けが未設定
- チャット初期化を再実行

### **質問が改善されない**
- システムプロンプトの更新が反映されているか確認
- `prompts/system_prompt.txt`に論証分析セクションが追加されているか確認

## 📝 まとめ

論理エンジンの統合により、AIファシリテーターは：
- ✅ 議論の構造を理解
- ✅ 価値観の対立を特定  
- ✅ 深層的な質問を生成
- ✅ より効果的な合意形成支援

テストページ（http://localhost:5000/chat_test）で動作確認を行い、期待通りの改善効果を確認してください。