{% extends "base.html" %}

{% block title %}{% if phase == 'pre' %}事前{% else %}事後{% endif %}質問紙 - 意思決定実験システム{% endblock %}

{% block content %}
<div class="questionnaire-section">
    <h2>
        {% if phase == 'pre' %}
            事前質問紙
        {% else %}
            {% if trial == 1 %}
                練習セッション完了 - フィードバック
            {% else %}
                事後質問紙 (本番 {{ trial - 1 }}/3)
            {% endif %}
        {% endif %}
    </h2>
    
    {% if phase == 'post' and trial == 1 %}
    <div class="trial-complete-message">
        <p><strong>練習セッションが完了しました！</strong><br>
        これから本番セッション1を開始します。練習の経験を活かして判断してください。</p>
    </div>
    {% endif %}
    
    <form id="questionnaireForm">
        {% if phase == 'pre' %}
        <div class="question-group">
            <label for="q1">1. 現在の気分はいかがですか？（1: とても悪い - 7: とても良い）</label>
            <div class="scale-input">
                <input type="range" id="q1" name="mood" min="1" max="7" value="4" class="slider">
                <div class="scale-labels">
                    <span>とても悪い</span>
                    <span class="scale-value" id="q1-value">4</span>
                    <span>とても良い</span>
                </div>
            </div>
        </div>

        <div class="question-group">
            <label for="q2">2. グループでの意思決定についてどの程度自信がありますか？（1: 全くない - 7: とてもある）</label>
            <div class="scale-input">
                <input type="range" id="q2" name="confidence" min="1" max="7" value="4" class="slider">
                <div class="scale-labels">
                    <span>全くない</span>
                    <span class="scale-value" id="q2-value">4</span>
                    <span>とてもある</span>
                </div>
            </div>
        </div>
        {% endif %}

        {% if phase == 'post' and trial > 1 %}
        <div class="question-group">
            <label for="q3">3. このセッションでの意思決定プロセスに満足していますか？（1: 全く満足していない - 7: とても満足している）</label>
            <div class="scale-input">
                <input type="range" id="q3" name="satisfaction" min="1" max="7" value="4" class="slider">
                <div class="scale-labels">
                    <span>全く満足していない</span>
                    <span class="scale-value" id="q3-value">4</span>
                    <span>とても満足している</span>
                </div>
            </div>
        </div>

        <div class="question-group">
            <label for="q4">4. 他の参加者の意見は参考になりましたか？（1: 全く参考にならなかった - 7: とても参考になった）</label>
            <div class="scale-input">
                <input type="range" id="q4" name="usefulness" min="1" max="7" value="4" class="slider">
                <div class="scale-labels">
                    <span>全く参考にならなかった</span>
                    <span class="scale-value" id="q4-value">4</span>
                    <span>とても参考になった</span>
                </div>
            </div>
        </div>
        {% endif %}


        <button type="submit" class="btn btn-primary">次へ進む</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // スライダーの値を表示
    const sliders = document.querySelectorAll('.slider');
    sliders.forEach(slider => {
        const valueDisplay = document.getElementById(slider.id + '-value');
        slider.addEventListener('input', function() {
            valueDisplay.textContent = this.value;
        });
    });

    // フォーム送信
    document.getElementById('questionnaireForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            phase: '{{ phase }}',
            trial: {{ trial }},
            responses: {}
        };
        
        for (let [key, value] of formData.entries()) {
            data.responses[key] = value;
        }

        console.log('送信データ:', data);
        
        fetch('/save_questionnaire', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('レスポンスステータス:', response.status);
            return response.json();
        })
        .then(result => {
            console.log('サーバーからの応答:', result);
            if (result.success && result.next_url) {
                console.log('次のページに遷移:', result.next_url);
                window.location.href = result.next_url;
            } else if (result.error) {
                alert('エラー: ' + result.error);
            } else {
                alert('予期しない応答形式です。');
                console.error('Unexpected response:', result);
            }
        })
        .catch(error => {
            console.error('Fetch エラー:', error);
            alert('ネットワークエラーが発生しました: ' + error.message);
        });
    });
});
</script>
{% endblock %}